define(["base","datatables.net"],function(base,DataTable){
        var ids=[];
        var nodesObj=[];
        var name;
	    var start;
	    var end;
        var treeObj;
	    var loginUserId;
	    var ws;
        var mtIds = [];//参与方ID组

	    //通过相应的直播id查询直播间信息
		function setLiveRoom(){
			if($("#liveIdControlDetail").val()){
				$.ajax({
	                type: "GET",
	                async: false,
	                url:$.base + "/liveBroadCastController/getLiveDetailTwo/"+$("#liveIdControlDetail").val(),
	                contentType:"application/json",
					success:function(data){
						$("#liveName").text(decodeURI(data.title));
						$("#liveStartTime").text(formatDate(data.startTime));
				 	    $("#liveEndTime").text(formatDate(data.endTime));
				 	    name = $("#liveName").text();
					    start = $("#liveStartTime").text();
					    end = $("#liveEndTime").text();
					},
	                error:function(){
	                    alert("加载错误！");
	                }
				});
			}
		}

 	    var userName;
 	    var participants;
 	    var isAdmin;
 	    var participant;
 	    var ishost;//1主持人；2非主持
 	    var hospitalId;
 	    var mtId_old;
 	    var hospitalsName;
 	    var thisMtId;
 	    var sysRole;
 	    var adminName;
 	    var messageFunction={
            mtsStatus:function (obj,confId) {
                    var status=obj['mtsStatus'+confId];
                    console.log(participants);
                    $.each(participants,function(i,v){
                        var mt=status[v.mtId];
                        //是否在线
                        if(mt.online==1){
                            $('.circleIcon_'+v.mtId).attr("disabled",false).addClass("iconGreen");
                        }else{
                            $('.circleIcon_'+v.mtId).attr("disabled",true).removeClass("iconGreen");
                        }
                        //静麦开麦
                        if(mt.mute==0){
                            $('.shutdIcon_'+v.mtId).html("<i class='iconfont' title='静麦'>&#xe601;</i>");
                        }else{
                            $('.shutdIcon_'+v.mtId).html("<i class='iconfont' title='开麦'>&#xe7f0;</i>");
                        }
                        //静音停止静音
                        if(mt.silence==0){
                            $('.silenIcon_'+v.mtId).html("<i class='iconfont' title='静音'>&#xe62d;</i>");
                        }else{
                            $('.silenIcon_'+v.mtId).html("<i class='iconfont' title='停止静音'>&#xe64a;</i>");
                        }
                        //选定发言取消发言
                        if(mt.speaker==0&&mt.online==0){
                            $('.speakIcon_'+v.mtId).css("background","url('../images/pages/noSpeakerWhite.png') no-repeat center center");
                            $('.speakIcon_'+v.mtId).attr("title","选定发言");
                        }else if(mt.speaker==0&&mt.online==1){
                            $('.speakIcon_'+v.mtId).css("background","url('../images/pages/noSpeakerGreen.png') no-repeat center center");
                            $('.speakIcon_'+v.mtId).attr("title","选定发言");
                        }else if(mt.speaker==1&&mt.online==0){
                            $('.speakIcon_'+v.mtId).css("background","url('../images/pages/noSpeakerWhite.png') no-repeat center center");
                            $('.speakIcon_'+v.mtId).attr("title","取消发言");
                        }else if(mt.speaker==1&&mt.online==1){
                            $('.speakIcon_'+v.mtId).css("background","url('../images/pages/speakerGreen.png') no-repeat center center");
                            $('.speakIcon_'+v.mtId).attr("title","取消发言");
                        }
                        var isHostIcon = '<img src="'+$.base + "/images/pages/host.png"+'" title="主持人" />';
                        if(ishost==1||adminName=="kscc管理员"){
                            $.each(participants,function(x,y){
                                var pt=status[y.mtId];
                                $('.deleIcon_'+y.mtId).removeAttr("disabled");
                                if(y.ishost==1){
                                    //如果是主持人/管理员
                                    if(pt.online==1){
                                        //在线
                                        $('.hostIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");
                                        $('.shutdIcon_'+y.mtId+',.silenIcon_'+y.mtId+',.speakIcon_'+y.mtId+',.circleIcon_'+y.mtId).removeAttr("disabled").addClass("iconGreen");
                                        $('.talkIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");

                                    }else{
                                        //不在线
                                        $('.hostIcon_'+y.mtId+',.shutdIcon_'+y.mtId+',.silenIcon_'+y.mtId+',.speakIcon_'+y.mtId+',.circleIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");
                                        $('.lineOne,.lineTwo').attr("disabled",true);
                                        $('.lineOne').removeClass("iconGreen");
                                        $('.talkIcon_'+y.mtId).removeAttr("disabled").addClass("iconGreen");
                                    }
                                    //主持人图标
                                    $('.hostIcon_'+y.mtId).parents(".buttonIfont").siblings(".dragDetail").find(".hostFlag").html(isHostIcon);
                                }else{
                                    //主持人图标
                                    $('.hostIcon_'+y.mtId).parents(".buttonIfont").siblings(".dragDetail").find(".hostFlag").html("");
                                    if(pt.online==1){
                                        //在线
                                        $('.hostIcon_'+y.mtId+',.shutdIcon_'+y.mtId+',.silenIcon_'+y.mtId+',.speakIcon_'+y.mtId+',.circleIcon_'+y.mtId).removeAttr("disabled").addClass("iconGreen");
                                        $('.talkIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");
                                    }else{
                                        //不在线
                                        $('.hostIcon_'+y.mtId+',.shutdIcon_'+y.mtId+',.silenIcon_'+y.mtId+',.speakIcon_'+y.mtId+',.circleIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");
                                        $('.lineOne,.lineTwo').attr("disabled",true);
                                        $('.lineOne').removeClass("iconGreen");
                                        $('.talkIcon_'+y.mtId).removeAttr("disabled").addClass("iconGreen");
                                    }
                                }
                            });

                            var iconBtn="<button class='btn' title='主持人' disabled><i class='iconfont' disabled>&#xe61f;</i></button>"+
                                "<button class='btn' title='静麦' disabled><i class='iconfont' disabled>&#xe601;</i></button>"+
                                "<button class='btn' attr='' title='静音' disabled><i class='iconfont' disabled>&#xe62d;</i></button>"+
                                "<button class='btn addSpeaker' title='选定发言' disabled ></button>"+
                                "<button class='btn' title='呼叫' disabled><i class='iconfont' disabled>&#xe606;</i></button>"+
                                "<button class='btn' title='删除终端' disabled><i class='iconfont' style='color:red;'>&#xe666;</i></button>";

                            var number=(participants.length)/3;
                            var pageNumber=$("#liveCarousel .carousel-inner").find(".item").length;
                            //如果当前登录人是主持人或者系统管理员 则添加+号项
                            var  addLiStrs = "";
                            if(ishost==1||adminName=="kscc管理员"){
                                if(Math.floor(number) === number){
                                   addItemStrs="<div class='item' style='height:100%;'>" +
                                        "<ul class='carouselUl carouselUl_"+(pageNumber+1)+"' style='height:100%;margin:0 auto;'>" +
                                        "<li class='carousel_add carousel_"+(pageNumber+1)+" detailLi'>"+
                                        "<div class='heightFull'>"+
                                        "<div class='heightFull widthFull'>"+
                                        "<div class='addPartiDiv'>"+
                                        "<div class='detailBannerDiv'>"+
                                        "<div class='detailBgDiv'>" +
                                        "<div class='addParti'></div>"+
                                        "<div class='buttonIfont'>"+iconBtn+"</div>"+
                                        "</div>"+
                                        "</div>"+
                                        "</div>"+
                                        "</div>"+
                                        "</div>"+
                                        "</li>" +
                                        "</ul>" +
                                        "</div>";
                                    if($("#liveCarousel .carousel-inner .carousel_add").length==0){
                                        $("#liveCarousel .carousel-inner").append(addItemStrs);
                                        $("#liveCarouselCircle").append("<li data-target='#liveCarousel' data-slide-to='"+pageNumber+"'></li>");
                                    }

                                }else{
                                    addLiStrs="<li class='carousel_add detailLi'>"+
                                        "<div class='heightFull'>"+
                                        "<div class='heightFull widthFull'>"+
                                        "<div class='addPartiDiv'>"+
                                        "<div class='detailBannerDiv'>"+
                                        "<div class='detailBgDiv'>" +
                                        "<div class='addParti'></div>"+
                                        "<div class='buttonIfont'>"+iconBtn+"</div>"+
                                        "</div>"+
                                        "</div>"+
                                        "</div>"+
                                        "</div>"+
                                        "</div>"+
                                        "</li>";

                                    if($("#liveCarousel .carousel-inner .carousel_add").length==0){
                                        $("#liveCarousel .carousel-inner .item:last ul").append(addLiStrs);
                                        setAddParti();
                                    }
                                }
                            }
                            $('#liveCarousel').carousel({
                                pause: true,
                                interval: false
                            });
                        }else{
                            //如果不是主持人/管理员
                            $.each(participants,function(x,y){
                                var pt=status[y.mtId];
                                //只要不是主持人或者管理员，按钮一直为灰色带斜杠的图标
                                $('.speakIcon_'+v.mtId).css("background","url('../images/pages/noSpeakerWhite.png') no-repeat center center");
                                $('.speakIcon_'+v.mtId).attr("title","取消发言");
                                //主持人图标
                                if(y.ishost==1){
                                    $('.hostIcon_'+y.mtId).parents(".buttonIfont").siblings(".dragDetail").find(".hostFlag").html(isHostIcon);
                                }else{
                                    $('.hostIcon_'+y.mtId).parents(".buttonIfont").siblings(".dragDetail").find(".hostFlag").html("");
                                }
                                if(pt.online==1){
                                    $('.lineOne,.lineTwo').removeAttr("disabled");
                                    $('.lineOne').addClass("iconGreen");
                                    $('.talkIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");
                                    $('.circleIcon_'+y.mtId).removeAttr("disabled").addClass("iconGreen");

                                    if(loginUserId==y.loginId){
                                        //如果是自身
                                        $('.deleIcon_'+y.mtId).removeAttr("disabled");
                                        $('.shutdIcon_'+y.mtId+',.silenIcon_'+y.mtId).removeAttr("disabled").addClass("iconGreen");
                                        $('.hostIcon_'+y.mtId+',.speakIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");
                                    }else{
                                        $('.deleIcon_'+y.mtId).attr("disabled",true);
                                        $('.hostIcon_'+y.mtId+',.shutdIcon_'+y.mtId+',.silenIcon_'+y.mtId+',.speakIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");
                                    }
                                }else{
                                    $('.deleIcon_'+y.mtId).attr("disabled",true);
                                    $('.lineOne,.lineTwo').attr("disabled",true);
                                    $('.lineOne').removeClass("iconGreen");
                                    $('.circleIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");
                                    $('.hostIcon_'+y.mtId+',.shutdIcon_'+y.mtId+',.silenIcon_'+y.mtId+',.speakIcon_'+y.mtId).attr("disabled",true).removeClass("iconGreen");
                                    $('.talkIcon_'+y.mtId).removeAttr("disabled").addClass("iconGreen");
                                }
                            })
                            $("#liveCarousel .carousel-inner .carousel_add").remove();
                            var pages = $("#liveCarousel .carousel-inner .item").length;
                            var pos = $("#liveCarousel .carousel-inner .item:eq("+(pages-1)+")").find("li").length;
                            if(pos<1){
                                $("#liveCarousel .item:last").remove();
                                $("#liveCarouselCircle").find("li:last").remove();
                            }
                        }
                    });


            },
            switchHost:function (obj,confId) {
                var role_id=obj['switchHost'+confId];
                var ishostNow=role_id[loginUserId];
                $.ajax({
    	            type:"post",
    	            url:$.base+"/liveBroadCastController/getCurrentParticipant",
    	            contentType:"application/json",
    	            data:JSON.stringify({
                        "confId":$("#confId").val(),
                        "liveId":$("#liveIdControlDetail").val()
                    }),
    	            success:function (data) {
    	            	participants=data.data;
    	            }
                });
                if((ishost==2)&&(ishostNow!=ishost)){
                    //由非主持人变为主持人
                    $.ajax({
                        type: "post",
                        async: true,
                        url:  $.base + "/liveBroadCastController/getMeetingInfo",
                        contentType:"application/json",
                        data:JSON.stringify({
                            "confId":$("#confId").val()
                        }),
                        dataType: "json",
                        success: function(data){
                            console.log(data);
                            if(data.status==='1'){
                                $(".menuAdmin").html("");
                                var hostStr="<button class='btn screenIcon' title='画面选看'><i class='iconfont'>&#xe626;</i></button>"+
                                    "<button class='btn synthesisIcon' title='画面合成'><i class='iconfont'>&#xe644;</i></button>"+
                                    "<button class='btn allShutIcon'></button><button class='btn allSilenIcon'></button>"+
                                    "<button class='btn subtitleIcon' title='添加字幕'><i class='iconfont'>&#xe60e;</i></button>"+
                                    "<button class='btn recordIcon' title='会场记录'><i class='iconfont'>&#xe619;</i></button>"+
                                    "<button class='btn applyExtendTime' title='申请延长直播'><i class='iconfont'>&#xe611;</i></button>"+
                                    "<button class='btn outLive' title='退出直播'><i class='iconfont' style='color:red;'>&#xe605;</i></button>"+
                                    "<button class='btn endLive' title='结束直播'><i class='iconfont' style='color:red;'>&#xe61b;</i></button>";
                                $(".menuAdmin").append(hostStr);
                                var mute=data.data.mute;//静麦开麦
                                var silence=data.data.silence;//静音停止静音
                                $(".allShutIcon").attr("att",mute);
                                $(".allSilenIcon").attr("att",silence);
                                if(mute==0){//0给他静麦  1给他开麦
                                    $(".allShutIcon").html("<i class='iconfont'>&#xe601;</i>");
                                    $(".allShutIcon").attr("title","全场静麦");
                                }else{
                                    $(".allShutIcon").html("<i class='iconfont'>&#xe7f0;</i>");
                                    $(".allShutIcon").attr("title","全场开麦");
                                }
                                if(silence==0){
                                    $(".allSilenIcon").html("<i class='iconfont'>&#xe62d;</i>");
                                    $(".allSilenIcon").attr("title","全场静音");
                                }else{
                                    $(".allSilenIcon").html("<i class='iconfont'>&#xe64a;</i>");
                                    $(".allSilenIcon").attr("title","全场停止静音");
                                }
                                setChange();
                            }
                        }
                    });
                    ishost='1';
                }
                else if((ishost==1)&&(ishostNow!=ishost)){
                    //由主持人变为非主持人
                    // ws.close();
                    $(".menuAdmin").html("");
                    var nohostStr="<button class='btn screenIcon' title='画面选看'><i class='iconfont'>&#xe626;</i></button>"+
                        "<button class='btn subtitleIcon' title='添加字幕'><i class='iconfont'>&#xe60e;</i></button>"+
                        "<button class='btn recordIcon' title='会场记录'><i class='iconfont'>&#xe619;</i></button>"+
                        "<button class='btn applySpeak' title='申请发言'><i class='iconfont'>&#xe612;</i></button>"+
                        "<button class='btn outLive' title='退出直播'><i class='iconfont' style='color:red;'>&#xe605;</i></button>";
                    $(".menuAdmin").append(nohostStr);
                    ishost='2';
                    setChange();
                }


            },
            apply:function (obj,confId) {
                var message=obj.apply;
                var delayHosName=message.split("直播")[0].split("申请")[0];
                var delayTime1=message.split("直播")[1];
                var delayTime=delayTime1.split("分钟")[0];

                if((message).indexOf(confId)!==-1){
                    if(sysRole=='kscc管理员'){
                        var modal=base.modal({
                            label:"提示",
                            context:"<div style='text-align:center;font-size:13px;'>"+message.replace(confId,'')+"</div>",
                            width:250,
                            height:80,
                            buttons:[
                                     {
                                        label:"同意",
                                        cls:"btn btn-info",
                                        clickEvent:function(){
                                        	var parmas={
                        						    "confId":confId,
                        							"delay_time":delayTime
                        						 };
                                        	var requestTip=base.requestTip({position:"center"});
	                               			$.ajax({
	                               	              type: "post",
	                               	              url:  $.base + "/liveController/extendTime",
	                               				  data:JSON.stringify(parmas),
	                                              contentType:"application/json",
	                               	              success: function(data){
	                               		               switch(data.status){
	                               			            	 case '1':
	                               				            	 requestTip.success("延时成功！");
	                               				            	 extendTime(delayTime);
	                               				            	 modal.hide();
	                               				            	 var message=delayHosName+"延长直播"+delayTime+"分钟申请通过!";
	                               							     message=JSON.stringify({extend:message});
	                               							     ws.send(message);
	                               			            		 break;
	                               		            		 default:
	                               		            			 requestTip.error("延时失败！");
	                               		            		     break;
	                               		            	 }

	                               		             },
	                               		             beforeSend:function(){
	                               		            	 requestTip.wait();
	                               		             },
	                               	            	 error:function(){
	                               	            		 requestTip.error();
	                               		             }
                               			     });

                                        }
                                     },
                                     {
                                        label:"拒绝",
                                        cls:"btn btn-warning",
                                        clickEvent:function(){
                                        	modal.hide();
                                        	var message=delayHosName+"延长直播"+delayTime+"分钟申请未通过!";
              							     message=JSON.stringify({extend:message});
              							     ws.send(message);
                                        }
                                     }
                                  ]
                        });
                    }
                    else{
                        if(ishost=='1'){
                            if(message.indexOf('发言')!==-1){
                                base.confirm({
                                    label:"提示",
                                    text:"<div style='text-align:center;font-size:13px;'>"+message.replace(confId,'')+"</div>"
                                });
                            }
                        }
                    }
                }
            },
            extend:function (obj,confId) {
            	if(sysRole!='kscc管理员'){
            		base.confirm({
  			    	  label:"提示",
  			    	  text:"<div style='text-align:center;font-size:13px;'>"+obj.extend.replace(confId,'')+"</div>"
  				    });
            	    setLiveRoom();
            	}
            },
            extendAdmin:function (obj,confId) {
            	if(sysRole!='kscc管理员'){
	            	base.confirm({ 
				    	  label:"提示",
				    	  text:"<div style='text-align:center;font-size:13px;'>"+obj.extendAdmin.replace(confId,'')+"</div>"
					});
	            	setLiveRoom();
            	}
            },
            silence:function (obj,confId) {
                var silence=obj.silence;
                if((silence).indexOf(confId)!==-1){
                    var value = silence.replace(confId, '');
                    if(value=='0'){
                        var allSilenStr="<i class='iconfont'>&#xe64a;</i>";
                        $(".allSilenIcon").attr("att",'1');
                        $(".allSilenIcon").html(allSilenStr);
                        $(".allSilenIcon").attr("title","全场停止静音");
                    }
                    else{
                        var allSilenStr="<i class='iconfont'>&#xe62d;</i>";
                        $(".allSilenIcon").attr("att",'0');
                        $(".allSilenIcon").html(allSilenStr);
                        $(".allSilenIcon").attr("title","全场静音");
                    }
                }
            },
            mute:function (obj,confId) {
                var mute=obj.mute;
                if((mute).indexOf(confId)!==-1){

                    var value = mute.replace(confId, '');
                    if(value=='0'){
                        var allShutStr="<i class='iconfont'>&#xe7f0;</i>";
                        $(".allShutIcon").attr("att",'1');
                        $(".allShutIcon").html(allShutStr);
                        $(".allShutIcon").attr("title","全场开麦");
                    }
                    else{
                        var allShutStr="<i class='iconfont'>&#xe601;</i>";
                        $(".allShutIcon").attr("att",'0');
                        $(".allShutIcon").html(allShutStr);
                        $(".allShutIcon").attr("title","全场静麦");
                    }
                }
            },
            deleteParticipant:function (obj,confId) {
                var param = obj.deleteParticipant;
                var thisConfId=param.confId;
                var mtId = param.mtid;
                var isQuit = param.isQuit==false?param.isQuit:true;
                $.ajax({
                    type:"post",
                    url:$.base+"/liveBroadCastController/getCurrentParticipant",
                    contentType:"application/json",
                    data:JSON.stringify({
                        "confId":$("#confId").val(),
                        "liveId":$("#liveIdControlDetail").val()
                    }),
                    success:function (data) {
                        participants=data.data;
                        if(participants.length>1){
                            if(thisConfId==confId){
                                //根据mtid,全用dom对参与方进行删除操作
                                var mtIdArr=[];
                                $.each(participants,function(i,v){
                                    mtIdArr.push(v.mtId);
                                });
                                var index=$.inArray(mtId,mtIdArr);
                                mtIds.splice(index,1);
                                // participants.splice(index,1);
                                delItem(mtId);
                                //退出直播间
                                if(ishost!=1&&mtId==thisMtId){
                                    var url=$.base+"/loginController/toLiveControlList";
                                    $.ajax({
                                        type:"GET",
                                        url:url,
                                        error:function(){
                                            alert("加载错误！");
                                        },
                                        success:function(e2){
                                            if(e2.indexOf('06a5bb21-b8f0-4dfd-8004-4b4e17d4f81c')!==-1){
                                                window.location.href=$.base+'/loginController/toLogin'
                                                return
                                            }
                                            $(".middle").html(e2);
                                        }
                                    });
                                }
                            }
                        }else{
                            //退出直播间
                            var url=$.base+"/loginController/toLiveControlList";
                            $.ajax({
                                type:"GET",
                                url:url,
                                error:function(){
                                    alert("加载错误！");
                                },
                                success:function(e2){
                                    if(e2.indexOf('06a5bb21-b8f0-4dfd-8004-4b4e17d4f81c')!==-1){
                                        window.location.href=$.base+'/loginController/toLogin'
                                        return
                                    }
                                    $(".middle").html(e2);
                                }
                            });

                        }

                    }
                });
                },
            addParticipant:function (obj,confId) {
                //对参与方进行新增
                var param = obj.addParticipant;
                var thisConfId=param.confId
                if(thisConfId==confId){
                    //paticipant,全用dom对参与方进行新增操作
                    $.ajax({
        	            type:"post",
        	            url:$.base+"/liveBroadCastController/getCurrentParticipant",
        	            contentType:"application/json",
        	            data:JSON.stringify({
                            "confId":$("#confId").val(),
                            "liveId":$("#liveIdControlDetail").val()
                        }),
        	            success:function (data) {
        	            	participants=data.data;
                            //DOM新增
                            if(participants.length>0){
                                $.each(participants,function(index,item){
                                    var mtId = item.mtId;
                                    if(mtIds.indexOf(mtId)==-1){
                                        addItem(item);
                                    }
                                });
                            }
        	            }
                    });
                }
            },
            endLive:function(obj,confId){
 	    	    var thisConfId=obj.endLive
 	    	    if(thisConfId==confId){
                    var url=$.base+"/loginController/toLiveControlList";
                    $.ajax({
                        type:"GET",
                        url:url,
                        error:function(){
                            alert("加载错误！");
                        },
                        success:function(data){
                            if(data.indexOf('06a5bb21-b8f0-4dfd-8004-4b4e17d4f81c')!==-1){
                                window.location.href=$.base+'/loginController/toLogin'
                                return
                            }
                            $(".middle").html(data);
                        }
                    });
                }
            },
			hostOut:function (obj,confId) {
                // var thisConfId=obj.confId
                var thisConfId = obj.hostOut;
				if(thisConfId==confId){
                 //主持人退出会议，自动随机切换下个主持人，调用getCurrentParticipant，dom操作左边参与方！
					$.ajax({
	    	            type:"post",
	    	            url:$.base+"/liveBroadCastController/getCurrentParticipant",
	    	            contentType:"application/json",
	    	            data:JSON.stringify({
	                        "confId":$("#confId").val(),
	                        "liveId":$("#liveIdControlDetail").val()
	                    }),
	    	            success:function (data) {
	    	            	participants=data.data;
                            $.each(participants,function(index,item){
                                if(item.loginId == loginUserId){
                                    ishost = item.ishost;
                                }
                            });
                            if(ishost==1){
                                setToHost();//由非主持人变成主持人
                            }
	    	            }
	                });

				}
            },
			confAutoEnd:function (obj,confId) {
                var url=$.base+"/loginController/toLiveControlList";
                $.ajax({
                    type:"GET",
                    url:url,
                    error:function(){
                        alert("加载错误！");
                    },
                    success:function(e2){
                        if(e2.indexOf('06a5bb21-b8f0-4dfd-8004-4b4e17d4f81c')!==-1){
                            window.location.href=$.base+'/loginController/toLogin'
                            return
                        }
                        $(".middle").html(e2);
                    }
                });
            },

            switchSpeaker:function(obj,confId){

            }


        }


		//新增参与方
        function addItem(v){
            /*
             * 如果是主持人：
             *    在倒数第二个位置添加参与方
             * 如果是普通参与方：
             *   在倒数第一个位置添加参与方
             */
            //参与方ID组
            if(mtIds.length>0){
                $.each(mtIds,function(index,item){
                    if(mtIds.indexOf(v.mtId)==-1){
                        mtIds.push(v.mtId);
                    }
                })
            }
            var pages = $("#liveCarousel .carousel-inner .item").length;
            var pos = $("#liveCarousel .carousel-inner .item:eq("+(pages-1)+") .carouselUl").find("li").length;
            var appendHtml = "";
            var mutePStr="";
            var silencePStr="";
            var speakPStr="";
            var hostIcon = "";
            var conversionCircuit = "";
            var ifontCircle = "";
            var speakBtn = new Object();
            //静麦开麦
            if(v.mute==0){
                mutePStr="<i class='iconfont' title='静麦'>&#xe601;</i>";
            }else{
                mutePStr="<i class='iconfont' title='开麦'>&#xe7f0;</i>";
            }
            //静音哑音
            if(v.silence==0){
                silencePStr="<i class='iconfont' title='静音'>&#xe62d;</i>";
            }else{
                silencePStr="<i class='iconfont' title='停止静音'>&#xe64a;</i>";
            }
            if(v.ishost == 1){
                hostIcon="<img src= '"+$.base+"/images/pages/host.png' title='主持人'>";
            }
            //判断是否在线
            if(v.online == 1){
                /*
                 * 如果在线：
                 *   右上角在线提示为绿色，即在线
                 */
                ifontCircle="<button class='btn iconGreen circleIcon circleIcon_"+v.mtId+"'><i class='iconfont' title=''>&#xe645;</i></button>";

            }else{
                /*
                 * 如果不在线：
                 *   右上角在线提示为灰色，即不在线
                 */
                ifontCircle="<button disabled class='btn circleIcon circleIcon_"+v.mtId+"'><i class='iconfont' title=''>&#xe645;</i></button>";
            }
            //如果为自身
            if(ishost==1||adminName=="kscc管理员"){
                (v.speaker==1)?speakBtn ={"title":"取消发言"}:speakBtn ={"title":"选定发言"};
                //判断是否在线
                if(v.online == 1){
                    /*
                     * 如果在线：
                     *   右上角在线提示为绿色，即在线
                     *   操作按钮分情况讨论：
                     *        1.主持人按钮（ishost）：1——置灰，2——高亮
                     *        2.静麦/开麦按钮（mute）：1——高亮，2——置灰
                     *        3.静音/哑音按钮(silence)：1——高亮，2——置灰
                     *        4.指定发言/取消发言按钮：1——发言，0——不可发言
                     */
                    //右上角在线提示为绿色
                    ifontCircle="<button class='btn iconGreen circleIcon circleIcon_"+v.mtId+"'><i class='iconfont' title=''>&#xe645;</i></button>";
                    //设置按钮初始化

                    /*
                     * 如果登录人是主持人/管理员：
                     *    本身主持人按钮为灰色（不可点击），其他人为绿色（可点击），表示主持人有权限切换主持人
                     *    选定发言和取消发言均为绿色（可点击），表示主持人有权限指定谁为主讲人，且主讲人只有一个
                     */
                    if(v.ishost==1){
                        hostBtn ={"disabled":"disabled","cls":"disable"};
                    }else{
                        hostBtn ={"disabled":"enabled","cls":"iconGreen"};
                    }
                    speakBtn.disabled = "enabled";
                    speakBtn.cls = "iconGreen";
                    callBtn ={"disabled":"disabled","cls":"disable"};
                    muteBtn ={"disabled":"enabled","cls":"iconGreen"};
                    silenceBtn ={"disabled":"enabled","cls":"iconGreen"};
                    ifont="<button "+hostBtn.disabled+" class='btn hostIcon "+hostBtn.cls+" hostIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='主持人'><i class='iconfont'>&#xe61f;</i></button>"+
                        "<button "+muteBtn.disabled+" class='btn shutdIcon "+muteBtn.cls+" shutdIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' mutePStatus='"+v.mute+"'>"+mutePStr+"</button>"+
                        "<button "+silenceBtn.disabled+" class='btn silenIcon "+silenceBtn.cls+" silenIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' silencePStatus='"+v.silence+"'>"+silencePStr+"</button>"+
                        "<button "+speakBtn.disabled+" class='btn speakIcon "+speakBtn.cls+" speakIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' speakPStatus='"+v.speaker+"' title='"+speakBtn.title+"'></button>"+
                        "<button "+callBtn.disabled+" class='btn talkIcon "+callBtn.cls+" talkIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='呼叫'><i class='iconfont'>&#xe606;</i></button>"+
                        "<button class='btn deleIcon deleIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.id+"' att3='"+v.hospitalName+"' title='删除终端'><i class='iconfont' style='color:red;'>&#xe666;</i></button>";

                }else{
                    /*
                     * 如果不在线：
                     *   右上角在线提示为灰色，即不在线
                     *   操作按钮只需设置呼叫和删除可点击
                     */
                    ifontCircle="<button disabled class='btn circleIcon circleIcon_"+v.mtId+"'><i class='iconfont' title=''>&#xe645;</i></button>";
                    ifont="<button disabled class='btn hostIcon hostIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='主持人'><i class='iconfont'>&#xe61f;</i></button>"+
                        "<button disabled class='btn shutdIcon shutdIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' mutePStatus='"+v.mute+"'>"+mutePStr+"</button>"+
                        "<button disabled class='btn silenIcon silenIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' silencePStatus='"+v.silence+"'>"+silencePStr+"</button>"+
                        "<button disabled class='btn speakIcon speakIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' speakPStatus='"+v.speaker+"' title='"+speakBtn.title+"'></button>"+
                        "<button class='btn talkIcon iconGreen talkIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='呼叫'><i class='iconfont'>&#xe606;</i></button>"+
                        "<button class='btn deleIcon deleIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.id+"' att3='"+v.hospitalName+"' title='删除终端'><i class='iconfont' style='color:red;'>&#xe666;</i></button>";
                }

            }else{
                if(loginUserId==v.loginId){
                    ifont="<button disabled class='btn hostIcon hostIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='主持人'><i class='iconfont'>&#xe61f;</i></button>"+
                        "<button class='btn iconGreen shutdIcon shutdIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' mutePStatus='"+v.mute+"'>"+mutePStr+"</button>"+
                        "<button class='btn iconGreen silenIcon silenIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' silencePStatus='"+v.silence+"'>"+silencePStr+"</button>"+
                        "<button disabled class='btn speakIcon speakIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' speakPStatus='"+v.speaker+"' title=''></button>"+
                        "<button disabled class='btn talkIcon talkIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='呼叫'><i class='iconfont'>&#xe606;</i></button>"+
                        "<button class='btn deleIcon deleIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.id+"' att3='"+v.hospitalName+"' title='删除终端'><i class='iconfont' style='color:red;'>&#xe666;</i></button>";

                }else{
                    ifont="<button disabled class='btn hostIcon hostIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='主持人'><i class='iconfont'>&#xe61f;</i></button>"+
                        "<button disabled class='btn shutdIcon shutdIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' mutePStatus='"+v.mute+"'>"+mutePStr+"</button>"+
                        "<button disabled class='btn silenIcon silenIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' silencePStatus='"+v.silence+"'>"+silencePStr+"</button>"+
                        "<button disabled class='btn speakIcon speakIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' speakPStatus='"+v.speaker+"' title=''></button>"+
                        "<button disabled class='btn talkIcon talkIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='呼叫'><i class='iconfont'>&#xe606;</i></button>"+
                        "<button disabled class='btn deleIcon deleIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.id+"' att3='"+v.hospitalName+"' title='删除终端'><i class='iconfont' style='color:red;'>&#xe666;</i></button>";
                }
            }
            //判断是否是自家医院
            if(v.hospitalId==hospitalId){
                conversionCircuit="<button class='btn lineOne_"+v.mtId+" lineOne' title='线路一'><i class='iconfont'>&#xe61a;</i>"+
                    "<button class='btn lineTwo_"+v.mtId+" lineTwo' title='线路二'><i class='iconfont'>&#xe61a;</i>";
            }
            appendHtml = "<li class='carousel_2 detailLi'>"+
                    "<div class='heightFull'>"+
                        "<div class='heightFull widthFull'>"+
                            "<div class='detailBannerLi' >"+
                                "<div class='detailBannerDiv'>"+
                                    "<div class='detailBgDiv'>"+
                                        "<div class='dragDetail' uid='"+v.mtId+"' uv='"+v.hospitalName+"'>"+
                                            "<span style='float:left;padding: 4px;' class='hostFlag'>"+hostIcon+"</span>"+
                                            "<span style='float:right;'>"+ifontCircle+"</span>"+
                                            "<div class='detailParti' title='"+v.hospitalName+"'>"+v.hospitalName+"</div>"+
                                        "</div>"+
                                        "<div class='buttonIfont'>"+ifont+"</div>"+
                                    "</div>"+
                                "</div>"+
                            "</div>"+
                            "<div class='conversionCircuit'>"+conversionCircuit+"</div>"+
                        "</div>"+
                    "</div>"+
                "</li>";
            var curPage = pages-1;
            if(ishost == 1){
                //如果是主持人，则在加号之前添加
                if( pos%3 > 0){
                    $("#liveCarousel .carousel-inner").find(".carousel_add").before(appendHtml);
                }else{
                    var addHtml = $("#liveCarousel").find(".carousel_add").html();
                    var nextPage = "<div class='item' style='height: 100%;'><ul class='carouselUl carousel_add detailLi'><li class='carousel_"+ pages +" detailLi'>"+addHtml+"</li></ul></div>";
                    $("#liveCarousel .carousel-inner").append(nextPage);
                    $("#liveCarousel .carousel-inner ul:eq("+curPage+")").find(".carousel_add").remove();
                    $("#liveCarousel .carousel-inner ul:eq("+curPage+")").append(appendHtml);
                    $("#liveCarouselCircle").append('<li data-target="#liveCarousel" data-slide-to="'+pages+'"></li>');
                }
            }else{
                //如果不是主持人，则添加在最后一页的最后一个
                if( pos%3 > 0){
                    $("#liveCarousel .carousel-inner").find("ul:eq("+curPage+")").append(appendHtml);
                }else{
                    var nextPage = "<div class='item' style='height: 100%;'><ul class='carouselUl carouselUl_"+(pages+1)+"'>"+appendHtml+"</ul></div>";
                    $("#liveCarousel .carousel-inner").append(nextPage);
                    //liveCarouselCircle
                    $("#liveCarouselCircle").append('<li data-target="#liveCarousel" data-slide-to="'+pages+'"></li>');
                }
            }
            setAddParti();
        }
        //删除参与方
        function delItem(mtId){
            $("#liveCarousel .carousel-inner li").each(function(index,item){
                if($(item).find(".hostIcon").attr("att1")==mtId){
                    var curPage = Math.ceil((index+1)/3)-1;
                    var curPos = index%3;
                    var nexts = $(this).parents(".item").nextAll();
                    if(nexts.length>0){
                        $.each(nexts,function(i1,o1){
                            var nextLi = $(o1).find("li")[0];
                            moveItem(curPage,curPos,nextLi);
                        })
                    }
                    $(this).remove();

                }
            });
        }
        //移动参与方
        function moveItem(curPage,curPos,nextLi){
            $("#liveCarousel .carousel-inner .item:eq("+curPage+") ul").append(nextLi);
            if($("#liveCarousel .carousel-inner .item:eq("+(curPage+1)+") li:eq(0)").length==0){
                $("#liveCarousel .carousel-inner .item:eq("+(curPage+1)+")").remove();
                $("#liveCarouselCircle").find("li:eq("+(curPage+1)+")").remove();
            }
            // $("#liveCarousel .carousel-inner .item:eq("+(curPage+1)+") li:eq(0)").remove();
        }
		//根据当前登录人配置菜单
	    function userId(){
	        $.ajax({
	            type:"post",
                async: false,
                url:$.base+"/liveBroadCastController/getUserId",
	            success:function (data) {
	                loginUserId=data.id;
	                userName=data.userName;
	                hospitalId=data.hospitalId;
	                if(data.roleName==="kscc管理员"){
	                	sysRole=data.roleName;
	                	adminName=data.roleName;
	                	isAdmin=true;
	                    $(".menuAdmin").html("");
                        var adminStr="<button class='btn screenIcon' title='画面选看'><i class='iconfont'>&#xe626;</i></button>"+
			                         "<button class='btn synthesisIcon' title='画面合成'><i class='iconfont'>&#xe644;</i></button>"+
			                         "<button class='btn allShutIcon'></button>"+
			                         "<button class='btn allSilenIcon'></button>"+
			                         "<button class='btn subtitleIcon' title='添加字幕'><i class='iconfont'>&#xe60e;</i></button>"+
			                         "<button class='btn delayIcon' title='延长直播'><i class='iconfont'>&#xe60d;</i></button>"+
		                             "<button class='btn closeVideo'  title='关闭录像'><i class='iconfont'>&#xe602;</i></button>"+
		                             "<button class='btn recordIcon' title='会场记录'><i class='iconfont'>&#xe619;</i></button>"+
			                         "<button class='btn outLive' title='退出直播'><i class='iconfont' style='color:red;'>&#xe605;</i></button>"+
			                         "<button class='btn endLive' title='结束直播'><i class='iconfont' style='color:red;'>&#xe61b;</i></button>";
                        $(".menuAdmin").append(adminStr);
					    $(".addSelectPar").before("<div class='parListSele'>为     <select class='form-control partiList'></select>  选看画面</div>");
	                }
					else{
                        $.ajax({
                            type:"POST",
                            async: false,
                            url:$.base+"/liveController/getParticipant",
                            dataType:'json',
                            contentType:"application/json",
                            data:JSON.stringify({
                                id:loginUserId,
                                liveId:$("#liveIdControlDetail").val()
                            }),
                            success:function (data) {
                                participant=data;
                                ishost=participant.ishost
                                thisMtId=data.mtId;

                                if(participant.ishost==1){
                                    sysRole='1';
                                    $(".menuAdmin").html("");
                                    var hostStr="<button class='btn screenIcon' title='画面选看'><i class='iconfont'>&#xe626;</i></button>"+
                                        "<button class='btn synthesisIcon' title='画面合成'><i class='iconfont'>&#xe644;</i></button>"+
                                        "<button class='btn allShutIcon'></button><button class='btn allSilenIcon'></button>"+
                                        "<button class='btn subtitleIcon' title='添加字幕'><i class='iconfont'>&#xe60e;</i></button>"+
                                        "<button class='btn recordIcon' title='会场记录'><i class='iconfont'>&#xe619;</i></button>"+
                                        "<button class='btn applyExtendTime' title='申请延长直播'><i class='iconfont'>&#xe611;</i></button>"+
                                        "<button class='btn outLive' title='退出直播'><i class='iconfont' style='color:red;'>&#xe605;</i></button>"+
                                        "<button class='btn endLive' title='结束直播'><i class='iconfont' style='color:red;'>&#xe61b;</i></button>";
                                    $(".menuAdmin").append(hostStr);
                                }else{
                                    $(".menuAdmin").html("");
                                    var nohostStr="<button class='btn screenIcon' title='画面选看'><i class='iconfont'>&#xe626;</i></button>"+
                                        "<button class='btn subtitleIcon' title='添加字幕'><i class='iconfont'>&#xe60e;</i></button>"+
                                        "<button class='btn recordIcon' title='会场记录'><i class='iconfont'>&#xe619;</i></button>"+
                                        "<button class='btn applySpeak' title='申请发言'><i class='iconfont'>&#xe612;</i></button>"+
                                        "<button class='btn outLive' title='退出直播'><i class='iconfont' style='color:red;'>&#xe605;</i></button>";
                                    $(".menuAdmin").append(nohostStr);
                                }
                            }
                        })
					}
					setCarousel(hospitalId);//设置轮播
	            }
	        });
	    };

	    //由非主持人变为主持人
    function setToHost(){
        //由非主持人变为主持人
        $.ajax({
            type: "post",
            async: true,
            url:  $.base + "/liveBroadCastController/getMeetingInfo",
            contentType:"application/json",
            data:JSON.stringify({
                "confId":$("#confId").val()
            }),
            dataType: "json",
            success: function(data){
                console.log(data);
                if(data.status==='1'){
                    $(".menuAdmin").html("");
                    var hostStr="<button class='btn screenIcon' title='画面选看'><i class='iconfont'>&#xe626;</i></button>"+
                        "<button class='btn synthesisIcon' title='画面合成'><i class='iconfont'>&#xe644;</i></button>"+
                        "<button class='btn allShutIcon'></button><button class='btn allSilenIcon'></button>"+
                        "<button class='btn subtitleIcon' title='添加字幕'><i class='iconfont'>&#xe60e;</i></button>"+
                        "<button class='btn recordIcon' title='会场记录'><i class='iconfont'>&#xe619;</i></button>"+
                        "<button class='btn applyExtendTime' title='申请延长直播'><i class='iconfont'>&#xe611;</i></button>"+
                        "<button class='btn outLive' title='退出直播'><i class='iconfont' style='color:red;'>&#xe605;</i></button>"+
                        "<button class='btn endLive' title='结束直播'><i class='iconfont' style='color:red;'>&#xe61b;</i></button>";
                    $(".menuAdmin").append(hostStr);
                    var mute=data.data.mute;//静麦开麦
                    var silence=data.data.silence;//静音停止静音
                    $(".allShutIcon").attr("att",mute);
                    $(".allSilenIcon").attr("att",silence);
                    if(mute==0){//0给他静麦  1给他开麦
                        $(".allShutIcon").html("<i class='iconfont'>&#xe601;</i>");
                        $(".allShutIcon").attr("title","全场静麦");
                    }else{
                        $(".allShutIcon").html("<i class='iconfont'>&#xe7f0;</i>");
                        $(".allShutIcon").attr("title","全场开麦");
                    }
                    if(silence==0){
                        $(".allSilenIcon").html("<i class='iconfont'>&#xe62d;</i>");
                        $(".allSilenIcon").attr("title","全场静音");
                    }else{
                        $(".allSilenIcon").html("<i class='iconfont'>&#xe64a;</i>");
                        $(".allSilenIcon").attr("title","全场停止静音");
                    }
                    setChange();
                }
            }
        });
    }
	    function wsFunction(ws){
            var confId=$("#confId").val();
            ws.onopen = function () {
                console.log("webSocket服务已开启");
            }
            ws.onmessage = function (event) {
                var message = event.data;

                var obj=eval("("+message+")");
                var uniqueKey;
                var type;
                for (var key in obj)
                {
                    uniqueKey=key;
                }
                if(uniqueKey.indexOf(confId)!==-1){
                	type=uniqueKey.replace(confId,'')
				}
				else{
                	type=uniqueKey
				}
				console.log(obj);
				console.log(type);
                messageFunction[type](obj, confId);
            }

            ws.onerror = function (evt) {
                ws.close();
                console.log('websocket error', evt);
            }
            ws.onclose = function (evt) {
                ws.close();
                console.log('websocket is closed', evt);
            }
        }

		/**
		 * 时间戳转化为固定格式日期
		 * @param m
		 * @returns {string}
		 */
		function add0(m){return m<10?'0'+m:m }
		function formatDate(now) {
			var time = new Date(now);
			var year=time.getFullYear();
			var month=time.getMonth()+1;
			var date=time.getDate();
			var hour=time.getHours();
			var minute=time.getMinutes();
			var second=time.getSeconds();
			return year+'-'+add0(month)+'-'+add0(date)+' '+add0(hour)+':'+add0(minute);
		}
		//延时当前直播剩余时间
		function counter() { 
		   var remindTime = $("#liveEndTime").text(); //当前直播间的结束时间 
		   var str=remindTime.toString().replace(/-/g,"/");
		   var endTime = new Date(str);	
		   
		   var date = new Date();
		   /*转换成秒*/ 
		   var time = (endTime - date) / 1000; 

		   var day = Math.floor(time / (24 * 60 * 60));

		   var hour = Math.floor(time % (24 * 60 * 60) / (60 * 60));
		   
		   var minute = Math.floor(time % (24 * 60 * 60) % (60 * 60) / 60); 

		   // var second = Math.floor(time % (24 * 60 * 60) % (60 * 60) % 60);

		   var countDownObj={
				"day" :  day,
				"hour" :  hour,
				"minute" :  minute
		   }
		   return countDownObj;
		} 
		//加载左边参与方
		function setCarousel(hospitalId){
			$("#liveCarouselCircle").empty();
			$("#liveCarousel .carousel-inner").empty();
			 $.ajax({
                 type: "GET",
                 url:$.base + "/liveBroadCastController/getLiveDetailTwo/"+$("#liveIdControlDetail").val(),
                 contentType:"application/json",
	             success: function(data){
	            	 var mute=data.mute;//静麦开麦
	            	 var silence=data.silence;//静音停止静音
	            	 $(".allShutIcon").attr("att",mute);
                     $(".allSilenIcon").attr("att",silence);
                     if(mute==1){
                    	 $(".allShutIcon").html("<i class='iconfont'>&#xe7f0;</i>");
                    	 $(".allShutIcon").attr("title","全场开麦");
                     }else{
                    	 $(".allShutIcon").html("<i class='iconfont'>&#xe601;</i>");
                    	 $(".allShutIcon").attr("title","全场静麦");
                     }
                     if(silence==1){
                    	 $(".allSilenIcon").html("<i class='iconfont'>&#xe64a;</i>");
                         $(".allSilenIcon").attr("title","全场停止静音");
                     }else{
                    	 $(".allSilenIcon").html("<i class='iconfont'>&#xe62d;</i>");
                         $(".allSilenIcon").attr("title","全场静音");
                     }
	            	   var lis="";
	                   participants=data.participants;
                       $("#confId").val(data.confId);
                       var url="ws://"+$.base.substr(7)+"/websocket/"+data.confId;
					 //校验web socket是否在正常状态
					  if (ws) {
						 ws.close();
                         /*setInterval(function(){
							 if (ws.readyState !== 1) {
							 ws = new WebSocket(url)
						 	}
					 	 }, 6000)*/
					   }
                     ws= new WebSocket(url);
                     wsFunction(ws);
					 $.each(data.participants,function(i,v){
                        var ifont=""; //按钮图标集
                        var ifontCircle="";//是否在线原点
                        var conversionCircuit="";//线路一、二图标
                        var hostIcon="";//主持人图标

                         //参与方ID组
                         if(mtIds.length>0){
                             $.each(mtIds,function(index,item){
                                 if(mtIds.indexOf(v.mtId)==-1){
                                     mtIds.push(v.mtId);
                                 }
                             })
                         }else{
                             mtIds.push(v.mtId);
                         }


                        //会场第一主持人就是默认进入直播间的主讲人
                        if(v.ishost == 1){
                          $("#speakerMain").val(v.hospitalName);//改变前的医院名称
                          mtId_old = v.mtId;//改变前的mtid
                          hostIcon="<img src= '"+$.base+"/images/pages/host.png' title='主持人'>";
                        }

                         var mutePStr="";
                         var silencePStr="";
                         var speakPStr="";
                         //静麦开麦
                         if(v.mute==0){
                             mutePStr="<i class='iconfont' title='静麦'>&#xe601;</i>";
                         }else{
                             mutePStr="<i class='iconfont' title='开麦'>&#xe7f0;</i>";
                         }
                         //静音哑音
                         if(v.silence==0){
                             silencePStr="<i class='iconfont' title='静音'>&#xe62d;</i>";
                         }else{
                             silencePStr="<i class='iconfont' title='停止静音'>&#xe64a;</i>";
                         }
                         var hostBtn = new Object(),
                             muteBtn =  new Object(),
                             silenceBtn =  new Object(),
                             speakBtn = new Object(),
                             callBtn = new Object();
                         if(ishost==1||adminName=="kscc管理员"){
                             (v.speaker==1)?speakBtn ={"title":"取消发言"}:speakBtn ={"title":"选定发言"};
                             //判断是否在线
                             if(v.online == 1){
                                 /*
                                  * 如果在线：
                                  *   右上角在线提示为绿色，即在线
                                  *   操作按钮分情况讨论：
                                  *        1.主持人按钮（ishost）：1——置灰，2——高亮
                                  *        2.静麦/开麦按钮（mute）：1——高亮，2——置灰
                                  *        3.静音/哑音按钮(silence)：1——高亮，2——置灰
                                  *        4.指定发言/取消发言按钮：1——发言，0——不可发言
                                  */
                                 //右上角在线提示为绿色
                                 ifontCircle="<button class='btn iconGreen circleIcon circleIcon_"+v.mtId+"'><i class='iconfont' title=''>&#xe645;</i></button>";
                                 //设置按钮初始化

                                     /*
                                     * 如果登录人是主持人/管理员：
                                     *    本身主持人按钮为灰色（不可点击），其他人为绿色（可点击），表示主持人有权限切换主持人
                                     *    选定发言和取消发言均为绿色（可点击），表示主持人有权限指定谁为主讲人，且主讲人只有一个
                                     */
                                     if(v.ishost==1){
                                         hostBtn ={"disabled":"disabled","cls":"disable"};
                                     }else{
                                         hostBtn ={"disabled":"enabled","cls":"iconGreen"};
                                     }
                                     speakBtn.disabled = "enabled";
                                     speakBtn.cls = "iconGreen";
                                     callBtn ={"disabled":"disabled","cls":"disable"};
                                     muteBtn ={"disabled":"enabled","cls":"iconGreen"};
                                     silenceBtn ={"disabled":"enabled","cls":"iconGreen"};
                                     ifont="<button "+hostBtn.disabled+" class='btn hostIcon "+hostBtn.cls+" hostIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='主持人'><i class='iconfont'>&#xe61f;</i></button>"+
                                         "<button "+muteBtn.disabled+" class='btn shutdIcon "+muteBtn.cls+" shutdIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' mutePStatus='"+v.mute+"'>"+mutePStr+"</button>"+
                                         "<button "+silenceBtn.disabled+" class='btn silenIcon "+silenceBtn.cls+" silenIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' silencePStatus='"+v.silence+"'>"+silencePStr+"</button>"+
                                         "<button "+speakBtn.disabled+" class='btn speakIcon "+speakBtn.cls+" speakIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' speakPStatus='"+v.speaker+"' title='"+speakBtn.title+"'></button>"+
                                         "<button "+callBtn.disabled+" class='btn talkIcon "+callBtn.cls+" talkIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='呼叫'><i class='iconfont'>&#xe606;</i></button>"+
                                         "<button class='btn deleIcon deleIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.id+"' att3='"+v.hospitalName+"' title='删除终端'><i class='iconfont' style='color:red;'>&#xe666;</i></button>";

                             }else{
                                 /*
                                 * 如果不在线：
                                 *   右上角在线提示为灰色，即不在线
                                 *   操作按钮只需设置呼叫和删除可点击
                                 */
                                 ifontCircle="<button disabled class='btn circleIcon circleIcon_"+v.mtId+"'><i class='iconfont' title=''>&#xe645;</i></button>";
                                 ifont="<button disabled class='btn hostIcon hostIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='主持人'><i class='iconfont'>&#xe61f;</i></button>"+
                                     "<button disabled class='btn shutdIcon shutdIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' mutePStatus='"+v.mute+"'>"+mutePStr+"</button>"+
                                     "<button disabled class='btn silenIcon silenIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' silencePStatus='"+v.silence+"'>"+silencePStr+"</button>"+
                                     "<button disabled class='btn speakIcon speakIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' speakPStatus='"+v.speaker+"' title='"+speakBtn.title+"'></button>"+
                                     "<button class='btn talkIcon iconGreen talkIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='呼叫'><i class='iconfont'>&#xe606;</i></button>"+
                                     "<button class='btn deleIcon deleIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.id+"' att3='"+v.hospitalName+"' title='删除终端'><i class='iconfont' style='color:red;'>&#xe666;</i></button>";
                             }
                         }else{
                             /*
                              * 如果登录人不是主持人/管理员：
                              *    只能操作自身
                              */
                             //判断是否在线
                             if(v.online == 1){
                                 /*
                                  * 如果在线：
                                  *   右上角在线提示为绿色，即在线
                                  */
                                 ifontCircle="<button class='btn iconGreen circleIcon circleIcon_"+v.mtId+"'><i class='iconfont' title=''>&#xe645;</i></button>";

                             }else{
                                 /*
                                  * 如果不在线：
                                  *   右上角在线提示为灰色，即不在线
                                  */
                                 ifontCircle="<button disabled class='btn circleIcon circleIcon_"+v.mtId+"'><i class='iconfont' title=''>&#xe645;</i></button>";
                             }
                             //如果为自身
                             if(loginUserId==v.loginId){
                                 ifont="<button disabled class='btn hostIcon hostIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='主持人'><i class='iconfont'>&#xe61f;</i></button>"+
                                     "<button class='btn iconGreen shutdIcon shutdIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' mutePStatus='"+v.mute+"'>"+mutePStr+"</button>"+
                                     "<button class='btn iconGreen silenIcon silenIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' silencePStatus='"+v.silence+"'>"+silencePStr+"</button>"+
                                     "<button disabled class='btn speakIcon speakIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' speakPStatus='"+v.speaker+"' title='"+speakBtn.title+"'></button>"+
                                     "<button disabled class='btn talkIcon talkIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='呼叫'><i class='iconfont'>&#xe606;</i></button>"+
                                     "<button class='btn deleIcon deleIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.id+"' att3='"+v.hospitalName+"' title='删除终端'><i class='iconfont' style='color:red;'>&#xe666;</i></button>";

                             }else{
                                 ifont="<button disabled class='btn hostIcon hostIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='主持人'><i class='iconfont'>&#xe61f;</i></button>"+
                                     "<button disabled class='btn shutdIcon shutdIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' mutePStatus='"+v.mute+"'>"+mutePStr+"</button>"+
                                     "<button disabled class='btn silenIcon silenIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' silencePStatus='"+v.silence+"'>"+silencePStr+"</button>"+
                                     "<button disabled class='btn speakIcon speakIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' speakPStatus='"+v.speaker+"' title='"+speakBtn.title+"'></button>"+
                                     "<button disabled class='btn talkIcon talkIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.hospitalName+"' title='呼叫'><i class='iconfont'>&#xe606;</i></button>"+
                                     "<button disabled class='btn deleIcon deleIcon_"+v.mtId+"' att='"+v.confId+"' att1='"+v.mtId+"' att2='"+v.id+"' att3='"+v.hospitalName+"' title='删除终端'><i class='iconfont' style='color:red;'>&#xe666;</i></button>";

                             }
                         }


                           //判断是否是自家医院
                           if(v.hospitalId==hospitalId){
                               conversionCircuit="<button class='btn lineOne_"+v.mtId+" lineOne' title='线路一'><i class='iconfont'>&#xe61a;</i>"+
                                                 "<button class='btn lineTwo_"+v.mtId+" lineTwo' title='线路二'><i class='iconfont'>&#xe61a;</i>";
                           }

                           var index=Math.ceil((i+1)/3);
                           lis+="<li class='carousel_"+index+" detailLi'>"+
                                     "<div class='heightFull'>"+
                                       "<div class='heightFull widthFull'>"+
                                            "<div class='detailBannerLi' >"+
                                                "<div class='detailBannerDiv'>"+
                                                   "<div class='detailBgDiv'>"+
                                                     "<div class='dragDetail' uid='"+v.mtId+"' uv='"+v.hospitalName+"'>"+
                                                        "<span style='float:left;padding: 4px;' class='hostFlag'>"+hostIcon+"</span>"+
                                                        "<span style='float:right;'>"+ifontCircle+"</span>"+
                                                        "<div class='detailParti' title='"+v.hospitalName+"'>"+v.hospitalName+"</div>"+
                                                     "</div>"+
                                                     "<div class='buttonIfont'>"+ifont+"</div>"+
                                                   "</div>"+
                                               "</div>"+
                                            "</div>"+
                                            "<div class='conversionCircuit'>"+conversionCircuit+"</div>"+
                                        "</div>"+
                                      "</div>"+
                              "</li>";
					 });
	            	 $("#liveCarousel .carousel-inner").append(lis);
	            	 for (var i=0;i<Math.ceil(data.participants.length/3);i++){
	            		   $(".carousel_"+(i+1)+"").wrapAll("<ul class='carouselUl carouselUl_"+(i+1)+"'></ul>");
	            		   $(".carouselUl_"+(i+1)+"").wrap("<div class='item' style='height:100%;'></div>");
	            		   $("#liveCarouselCircle").append("<li data-target='#liveCarousel' data-slide-to='"+i+"'></li>");
					 }
					 $(".item:first").addClass("active");
					 $("#liveCarouselCircle").children(":first").addClass("active");

					 if(sysRole=="kscc管理员"||sysRole==1){
						 var path=$.base;
						 var iconBtn="<button class='btn' title='主持人' disabled><i class='iconfont' disabled>&#xe61f;</i></button>"+
  			                       "<button class='btn' title='静麦' disabled><i class='iconfont' disabled>&#xe601;</i></button>"+
        			               "<button class='btn' attr='' title='静音' disabled><i class='iconfont' disabled>&#xe62d;</i></button>"+
        			               "<button class='btn addSpeaker' title='选定发言' disabled ></button>"+
        			               "<button class='btn' title='呼叫' disabled><i class='iconfont' disabled>&#xe606;</i></button>"+
        			               "<button class='btn' title='删除终端' disabled><i class='iconfont' style='color:red;'>&#xe666;</i></button>";

						 var number=(data.participants.length)/3;
	            	     var pageNumber=$("#liveCarousel .carousel-inner").find(".item").length;
					     //如果当前登录人是主持人或者系统管理员 则添加+号项
					     if(ishost==1||adminName=="kscc管理员"){
							   if(Math.floor(number) === number){
								   var addItemStrs="<div class='item' style='height:100%;'>" +
									   "<ul class='carouselUl carouselUl_"+(pageNumber+1)+"' style='height:100%;margin:0 auto;'>" +
									   "<li class='carousel_add carousel_"+(pageNumber+1)+" detailLi'>"+
									   "<div class='heightFull'>"+
									   "<div class='heightFull widthFull'>"+
									   "<div class='addPartiDiv'>"+
									   "<div class='detailBannerDiv'>"+
									   "<div class='detailBgDiv'>" +
									   "<div class='addParti'></div>"+
									   "<div class='buttonIfont'>"+iconBtn+"</div>"+
									   "</div>"+
									   "</div>"+
									   "</div>"+
									   "</div>"+
									   "</div>"+
									   "</li>" +
									   "</ul>" +
									   "</div>";

								   $("#liveCarousel .carousel-inner").append(addItemStrs);
								   $("#liveCarouselCircle").append("<li data-target='#liveCarousel' data-slide-to='"+pageNumber+"'></li>");
							   }else{
								   var  addLiStrs="<li class='carousel_add detailLi'>"+
									   "<div class='heightFull'>"+
									   "<div class='heightFull widthFull'>"+
									   "<div class='addPartiDiv'>"+
									   "<div class='detailBannerDiv'>"+
									   "<div class='detailBgDiv'>" +
									   "<div class='addParti'></div>"+
									   "<div class='buttonIfont'>"+iconBtn+"</div>"+
									   "</div>"+
									   "</div>"+
									   "</div>"+
									   "</div>"+
									   "</div>"+
									   "</li>";
								   $("#liveCarousel .carousel-inner .item:last ul").append(addLiStrs);
							   }
						  }
					     $('#liveCarousel').carousel({
						      pause: true,
						      interval: false
						 });

	             }

	            	   setDrag();//拖拽
	            	   setPartiClick();//参与方点击事件
	            	   setAddParti();//添加参与方模态框
	               },
	               error:function(e){}
			 });
		 };

		 function setAddParti(){
			 $(".carousel-inner").on("click",".addPartiDiv",function(){
				 $("#selectModal").modal('show');
				 $("#selectNum").text('0');
				 setZTreeModel();
			 });
		 }

		 var setting = {
					view: {
						selectedMulti:true,
					},
					data: {
						simpleData: {
							enable: true,
							pIdKey: "pid"
						}
					}
			  };
			function setZtree(zNodes){
				require(["bootstrap","ztreeCore","ztreeExcheck","ztreeExedit"],function(){
					$.fn.zTree.init($("#treeDemo1"), setting, zNodes);
					treeObj = $.fn.zTree.getZTreeObj("treeDemo1");
					treeObj.expandAll(true);
					setLi();
					setSelect();
					searchTree();//模态框医院列表数据搜索
				});
			}
		 //模态框里的树渲染
		 function setZTreeModel(){
			//获得医院列表数据
             var hospitalIds=[]
             $.each(participants,function (i,v) {
                 hospitalIds.push(v.hospitalId)
             })
				$.ajax({
					   type: "post",
		               async: true,
		               url:  $.base + "/hospital/screenHospital",
		               contentType:"application/json",
		               data:JSON.stringify({
		                     "hospitalIds":hospitalIds
		                     }),
		               dataType: "json",
		               success: function(data){
		            	 var zNodes =data;
		            	 setZtree(zNodes);//渲染医院列表
		               }
			      });
		 }
		 function setLi(){
				if($("#selectResult li").length>0){
					$("#selectResult li").click(function(){
						$(this).addClass("cur").siblings().removeClass("cur");
					});
				}
			}
		 //搜索
		 function searchTree(startTime,endTime){
				$("#searchBtnModel").unbind().on("click",function(){
					$.ajax({
			        	url:$.base+"/hospital/screenHospital",
			        	type:"POST",
			        	contentType:"application/json",
	                    dateType:"json",
	                    data:JSON.stringify(
	                        {
	                            "name":$("#searchParticipantModal").val(),
                                "startTime":startTime,
                                "endTime":endTime,
                                //"confId":$("#confId").val(),
	                        }
						),
			        	success:function(data){
			        		 var zNodes =data;
			            	 setZtree(zNodes,startTime,endTime);//渲染医院列表
			            	 setLi();
			        	},
			        	error:function(data){}
					});
				});
			}


		//左右选择框
		function setSelect(){
			//从左往右单选
			$("#LTRSingle").unbind().on("click",function(){
				var treeObj = $.fn.zTree.getZTreeObj("treeDemo1");
				var sNodes = treeObj.getSelectedNodes();
				if (sNodes.length > 0) {
					var node = sNodes[0].getParentNode();
				}
				var importId;var importName;var newvoid;
				if(node!=null){
					importId=node.id;
					importName=node.name;
					newvoid = node.newvoidNum;
					//mtId = node.mtId;
				}
				else{
					importId=sNodes[0].id;
					importName=sNodes[0].name;
                    newvoid=sNodes[0].newvoidNum;
                    //mtId = sNodes[0].mtId;
				}
				if(importId){
	                	 if(ids.length==0){
	                		ids.push(importId);
	                		nodesObj.push({
	                			"hospitalId":importId,
	                			"hospitalName":importName,
	                			"newVoidNum":newvoid,
                                "account":newvoid,
                                "account_type": 5,
                                "bitrate": 2048,
                                "protocol": 0,
                                "forced_call": 0,
	                		});
                            /*exObj.push({
								"mtId":mtId,
							});*/
	                		$("#selectResult").append("<li att='"+importId+"' class='partisLimodal'><span class='iconfont iconfontList'>&#xe61e;</span><span class='selectSpan' title='"+importName+"'>"+importName+"</span></li>");
	                	 }
	                	 else{
	                		 if($.inArray(importId,ids)==-1){
	 		                		ids.push(importId);
	 		                		nodesObj.push({
	 		                			"hospitalId":importId,
	 		                			"hospitalName":importName,
                                        "newVoidNum":newvoid,
										"account":newvoid,
                                        "account_type": 5,
										"bitrate": 2048,
										"protocol": 0,
										"forced_call": 0,
	 		                		});
                                 /*exObj.push({
                                     "mtId":mtId,
                                 });*/
	 		                $("#selectResult").append("<li att='"+importId+"' class='partisLimodal'><span class='iconfont iconfontList'>&#xe61e;</span><span class='selectSpan' title='"+importName+"'>"+importName+"</span></li>");
	 		              }
	                	}
	            	$("#selectNum").text($("#selectResult").find("li").length);
	            	setLi();
				}
			});

			//从右往左单选
			$("#RTLSingle").unbind().on("click",function(){
				setLi();
				var selectLiId=$("#selectResult li.cur").attr("att");
					var index=$.inArray(parseInt(selectLiId),ids);
					ids.splice(index,1);
					nodesObj.splice(index,1);
					$("#selectResult li.cur").remove();
					$("#selectNum").text($("#selectResult").find("li").length);
			});

			//模态框确定按钮
            var mts=[];
			$(".selectBtn").unbind().on("click",function(){
                $.each(nodesObj,function(i,v){
                    var obj={};
                    for(key in v){
                        if(key!=='hospitalName'&& key !=='newVoidNum' && key !=='hospitalId'){
                            obj[key]=v[key]
                        }
                    }
                    mts.push(obj);
                });
                var params={
                    "liveId":$("#liveIdControlDetail").val(),
                    "creatorId":loginUserId,
                    "searchParticipant":nodesObj,
                    "confId":$("#confId").val(),
                    "params":{
                        "mts":mts
                    }
                };

                var confId = $("#confId").val();
                var requestTip=base.requestTip({position:"center"});
				$.ajax({
					   type: "post",
		               async: true,
		               url:  $.base + "/liveController/inviteParticipant",
		               contentType:"application/json",
		               data:JSON.stringify(params),
		               success: function(data){
                           switch(data.status){
							   case '1':
                                   requestTip.success("成功！");

                                   ws.send(JSON.stringify({addParticipant:{confId: $("#confId").val(),participant:data.data}}))
                                  //reQuestMtid();
                                   //setCarousel();
                                   $('#selectModal').modal('hide');
                                   break;
                               default:
                                   requestTip.error("失败！");
                                   break;
                           }
		               }
			      });
			});

            //关闭模态框
            $('#selectModal').on('hidden.bs.modal', function () {
                $("#selectResult").empty();
                ids=[];
                nodesObj=[];
            });
		}

		 //参与方列表操作按钮控制
		function setPartiClick(){
			//主持人
            $(".carousel-inner").unbind().on("click",".hostIcon",function(){
				var hospitalNameNow=$(this).attr("att2");//现在的医院名称
				var confId=$(this).attr("att");
				var mt_id=$(this).attr("att1");
				var params={
							"hospitalNameEx":$("#speakerMain").val(),
							"hospitalNameNow":hospitalNameNow,
							"confId":confId,
							"mtIdOld":mtId_old,
							"params":{
								"mt_id":mt_id
								}
						 }
				var requestTip=base.requestTip({position:"center"});
				$.ajax({
	                 type: "POST",
	                 url:$.base + "/liveController/switchHost",
	                 data:JSON.stringify(params),
	                 contentType:"application/json",
		             success: function(data){

		            	 switch(data.status){
			            	 case '1':
			            		 requestTip.success("切换主持人成功！");
			            		 break;
		            		 default:
		            			 requestTip.error("切换主持人失败！");
		            		     break;
		            	 }
		             },
		             beforeSend:function(){
		            	 requestTip.wait();
		             },
	            	 error:function(){
	            		 requestTip.error();
		             }
		          });
			});
			//静麦
            $(".carousel-inner").on("click",".shutdIcon",function(){
				var _thisShut = this;
				var confId=$(this).attr("att");
				var mt_id=$(this).attr("att1");
				var status=$(this).attr("mutePStatus");
				var shutdStatus=$(this).find("i").attr("title");
				var shutdStr="";
				var params={
						"confId":confId,
						"mtId":mt_id,
						"params":{
							"value":status==0?1:0
							}
					 }
				var requestTip=base.requestTip({position:"center"});
				$.ajax({
					 type: "POST",
	                 url:$.base + "/liveController/mute",
	                 data:JSON.stringify(params),
	                 contentType:"application/json",
	                 success: function(data){
		            		 if(data.status=='1'){
		            			 if(status=="0"){
			            			 requestTip.success("静麦成功！");
			            			 $(_thisShut).addClass("iconGreen");
			            			 shutdStr="<i class='iconfont' title='开麦'>&#xe7f0;</i>";
			            			 $(_thisShut).html(shutdStr);
			            			 $(_thisShut).attr("mutePStatus","1");
			            		 }
			            		 else{
			            			 requestTip.success("开麦成功！");
			            			 $(_thisShut).addClass("iconGreen");
			            			 shutdStr="<i class='iconfont' title='静麦'>&#xe601;</i>";
			            			 $(_thisShut).html(shutdStr);
			            			 $(_thisShut).attr("mutePStatus","0");
			            		 }
		            		 }
		            		 else{
		            			 requestTip.error();
		            		 }
		             },
		             beforeSend:function(){
		            	 requestTip.wait();
		             },
	            	 error:function(){
	            		 requestTip.error();
		             }
		        });
			});
			//静音
            $(".carousel-inner").on("click",".silenIcon",function(){
				var _thisSilen = this;
				var confId=$(this).attr("att");
				var mt_id=$(this).attr("att1");
				var status=$(this).attr("silencePStatus");
				var silenStatus=$(this).find("i").attr("title");
				var silenStr="";
				var params={
						"confId":confId,
						"mtId":mt_id,
						"params":{
							"value":status==0?1:0
							}
					 }
				var requestTip=base.requestTip({position:"center"});
				$.ajax({
					 type: "POST",
	                 url:$.base + "/liveController/silence",
	                 data:JSON.stringify(params),
	                 contentType:"application/json",
	                 success: function(data){
		            	if(data.status=='1'){
		            		if(status=="0"){
		            			 requestTip.success("静音成功！");
		            			 $(_thisSilen).addClass("iconGreen");
		            			 silenStr="<i class='iconfont' title='停止静音'>&#xe64a;</i>";
		            			 $(_thisSilen).html(silenStr);
                                 $(_thisSilen).attr("silencePStatus","1");
		            		 }
		            		 else{
		            			 requestTip.success("停止静音成功！");
		            			 $(_thisSilen).addClass("iconGreen");
		            			 silenStr="<i class='iconfont' title='静音'>&#xe62d;</i>";
		            			 $(_thisSilen).html(silenStr);
		            			 $(_thisSilen).attr("silencePStatus","0");
		            		 }
		            	}
		            	else{
		            		requestTip.error();
			            	}
		             },
		             beforeSend:function(){
		            	 requestTip.wait();
		             },
	            	 error:function(){
	            		 requestTip.error();
		             }
		        });
			});

			//指定发言人
            $(".carousel-inner").on("click",".speakIcon",function(){
				var _thisSpeak = this;
				var confId=$(this).attr("att");
				var mt_id=$(this).attr("att1");
				//获取此mtId上的发言人状态，若为发言人则取消，
				// 传空字符串，若不为空，则指定他为发言人，正常传参
				var status=$(this).attr("speakPStatus");
				var speakStr="";
				var params={
							"confId":confId,
							"params":{
								"mt_id":status=='1'?'':mt_id
								}
						 }
				var requestTip=base.requestTip({position:"center"});
				$.ajax({
					 type: "POST",
	                 url:$.base + "/liveController/chooseSpeaker",
	                 data:JSON.stringify(params),
	                 contentType:"application/json",
	                 success: function(data){

		            	 switch(data.status){
			            	 case '1':
			            		 if(data.status=='1'){
                                         ws.send(JSON.stringify({switchSpeaker:{confId:confId,mtid:mt_id}}));
					            		if(status=="0"){
					            			 requestTip.success("选定发言成功！");
					            			 $(_thisSpeak).addClass("iconGreen");
					            			 $(_thisSpeak).css("background","url('../images/pages/speakerGreen.png') no-repeat center center");
					            			 $(_thisSpeak).attr("title","取消发言");
					            			 $(".speakIcon").attr("speakPStatus","0");
			                                 $(_thisSpeak).attr("speakPStatus","1");
                                             $("li.detailLi").each(function(index,item){
                                                 $(item).find(".mainSpeaker").remove();
                                             });
                                             var imgUrl = $.base + "/images/pages/speaker.png";
                                             $(_thisSpeak).parents("li").find(".dragDetail").prepend('<span style="float:left;padding: 4px;" class="mainSpeaker"><img src="'+imgUrl+'" title="主讲人"></span>');
			                                 $.ajax({
			                     	            type:"post",
			                     	            url:$.base+"/liveBroadCastController/getCurrentParticipant",
			                     	            contentType:"application/json",
			                     	            data:JSON.stringify({
			                                         "confId":$("#confId").val(),
			                                         "liveId":$("#liveIdControlDetail").val()
			                                    }),
			                     	            success:function (data) {
			                     	            	participants=data.data;
			                     	            	$.each(participants,function(i,v){
			                     	            		if(v.speaker==0&&v.online==1){
			                     	            			$('.speakIcon_'+v.mtId).css("background","url('../images/pages/noSpeakerGreen.png') no-repeat center center");
			                    	                    	$('.speakIcon_'+v.mtId).attr("title","选定发言");
			                     	            		}
			                     	            	});
			                     	            }
			                                 });
					            		 }
					            		 else{
					            			 requestTip.success("取消发言成功！");
					            			 $(_thisSpeak).addClass("iconGreen");
					            			 $(_thisSpeak).css("background","url('../images/pages/noSpeakerGreen.png') no-repeat center center");
					            			 $(_thisSpeak).attr("title","选定发言");
					            			 $(_thisSpeak).attr("speakPStatus","0");
                                            $("li.detailLi").each(function(index,item){
                                                $(item).find(".mainSpeaker").remove();
                                            });
					            		 }
					            	}
			            		 break;
		            		 default:
		            			 requestTip.error();
		            		     break;
		            	 }
		             },
		             beforeSend:function(){
		            	 requestTip.wait();
		             },
	            	 error:function(){
	            		 requestTip.error();
		             }
		       });
			});
			//呼叫
            $(".carousel-inner").on("click",".talkIcon",function(){
				var confId=$(this).attr("att");
				var mt_id=$(this).attr("att1");
				var hospitalName=$(this).attr("att2");
				var params={
							"confId":confId,
							"hospitalName":hospitalName,
							"params":{
								"mts":[{
									"mt_id":mt_id
								}]
								}
						 }
				var requestTip=base.requestTip({position:"center"});
				$.ajax({
					type: "POST",
	                url:$.base + "/liveController/callParticipant",
	                data:JSON.stringify(params),
	                contentType:"application/json",
	                success: function(data){

		            	 switch(data.status){
			            	 case '1':
			            		 requestTip.success("呼叫成功！");
			            		 break;
		            		 default:
		            			 requestTip.error("呼叫失败！");
		            		     break;
		            	 }
		             },
		             beforeSend:function(){
		            	 requestTip.wait();
		             },
	            	 error:function(){
	            		 requestTip.error();
		             }
		       });
			});
			//删除终端
            $(".carousel-inner").on("click",".deleIcon",function(){
				var _thisDele=this;
                var confId = $("#confId").val();
				var mt_id=$(this).attr("att1");
				var delayId=$(this).attr("att2");
				var hospitalName=$(this).attr("att3");
                var thisIsHost = $(_thisDele).parents(".detailBgDiv").find(".hostFlag img").length;//如果删除的这个是主持人的话
				var params={
							"hospitalName":hospitalName,
							"id":delayId,
							"confId":confId,
                            "num":participants.length,
                            "liveId":$("#liveIdControlDetail").val(),
							"params":{
								"mts":[{
									"mt_id":mt_id
								}]
                            }
                }
				var requestTip=base.requestTip({position:"center"});
                // if(participants.length>2) {
                    if ((ishost == 1&& mt_id == thisMtId)||(sysRole=="kscc管理员"&&thisIsHost==1)) {
                        var modal = base.modal({
                            label: "提示",
                            context: "<div style='text-align:center;font-size:13px;'>请先将主持人权限切换给其他参与方</div>",
                            width: 250,
                            height: 80,
                            buttons: [
                                {
                                    label: "确定",
                                    cls: "btn btn-info",
                                    clickEvent: function () {
                                        modal.hide();
                                    }
                                }
                            ]
                        });
                    } else if (ishost != 1&& mt_id == thisMtId){
                        var modal = base.modal({
                            label: "提示",
                            context: "<div style='text-align:center;font-size:13px;'>退出后不能参加该会议，确认退出？</div>",
                            width: 250,
                            height: 80,
                            buttons: [
                                {
                                    label: "确认",
                                    cls: "btn btn-info",
                                    clickEvent: function () {
                                        $.ajax({
                                            type: "POST",
                                            url: $.base + "/liveController/deleteParticipant",
                                            data: JSON.stringify(params),
                                            contentType: "application/json",
                                            success: function (data) {

                                                switch (data.status) {
                                                    case '1':
                                                        requestTip.success("删除成功！");
                                                        ws.send(JSON.stringify({
                                                            deleteParticipant: {
                                                                confId: confId,
                                                                mtid: mt_id,
                                                                isQuit: true
                                                            }
                                                        }));
                                                        modal.hide();

                                                        break;
                                                    default:
                                                        requestTip.error("删除失败！");
                                                        break;
                                                }
                                            },
                                            beforeSend: function () {
                                                requestTip.wait();
                                            },
                                            error: function () {
                                                requestTip.error();
                                            }
                                        });
                                    }
                                },
                                {
                                    label: "取消",
                                    cls: "btn btn-warning",
                                    clickEvent: function () {
                                        modal.hide();
                                    }
                                }
                            ]
                        });
                    } else if ((ishost == 1&& mt_id !== thisMtId)||(sysRole=="kscc管理员"&&thisIsHost==0)){
                        var modal = base.modal({
                            label: "提示",
                            context: "<div style='text-align:center;font-size:13px;'>确定删除该参与方吗？</div>",
                            width: 250,
                            height: 80,
                            buttons: [
                                {
                                    label: "确认",
                                    cls: "btn btn-info",
                                    clickEvent: function () {
                                        $.ajax({
                                            type: "POST",
                                            url: $.base + "/liveController/deleteParticipant",
                                            data: JSON.stringify(params),
                                            contentType: "application/json",
                                            success: function (data) {

                                                switch (data.status) {
                                                    case '1':
                                                        requestTip.success("删除成功！");
                                                        ws.send(JSON.stringify({
                                                            deleteParticipant: {
                                                                confId: confId,
                                                                mtid: mt_id,
                                                                isQuit: false
                                                            }
                                                        }));
                                                        modal.hide();
                                                        break;
                                                    default:
                                                        requestTip.error("删除失败！");
                                                        break;
                                                }
                                            },
                                            beforeSend: function () {
                                                requestTip.wait();
                                            },
                                            error: function () {
                                                requestTip.error();
                                            }
                                        });
                                    }
                                },
                                {
                                    label: "取消",
                                    cls: "btn btn-warning",
                                    clickEvent: function () {
                                        modal.hide();
                                    }
                                }
                            ]
                        });
                    }
                // }else{
                //
                // }
            });
		}

		 //会场记录表格
		function setTableRecord(){
			   $("#tblRecord").DataTable({
					"searching":false,
					"lengthChange":false,
					"autoWidth":false,
					"serverSide":true,
					"paging":true,
					"ordering":false,
					"bRetrieve": true,
					"language":{"url":$.base+"/js/lib/chinese.json"},
					"ajax":{
						"type":"post",
						"url":$.base+"/kscc/liveOperationLog/liveFbsLiveParticiList",
						"contentType":"application/json",
						"data": function ( d ) {
	                          var params={
	                        		  "pageNo": d.start/d.length+1,
			                          "pageSize": d.length,
			                          "param":{
			                        	  "id": $("#liveIdControlDetail").val()
			                          }
	                          };
//	                           $.extend(d,params);
	                         return JSON.stringify(params);
	                       }
						},
					"columns":[
                               {"title":"时间", "data":"operationTime","sWidth":"30%"},
					           {"title":"日志", "data":"operationContent","sWidth":"70%"}
					           ],
                   "columnDefs":[
                       {
                           "render":function(data,type,row,meta){
                               if(data != null && data != ''){
                                   return data.substr(0,16);
                               }
                           },
                           "targets":0
                       }
				   ]
				});
		    };

		//设置点击切换
		 function setChange(){
			 //全场哑音
			 $(".allShutIcon").unbind().on("click",function(){
				 var confId = $("#confId").val();
				 var status=$(".allShutIcon").attr("att");
				 var allShutStatus=$(".allShutIcon").attr("title");
			     var allShutStr="";
				 var params={
							"confId":confId,
							"params":{
								"value":status==0?1:0
								}
						 }
				    var requestTip=base.requestTip({position:"center"});
					$.ajax({
						type: "POST",
		                url:$.base + "/liveController/allMute",
		                data:JSON.stringify(params),
		                contentType:"application/json",
		                success: function(data){
			            	 switch(data.status){
				            	 case '1':

				            		 if(status=="0"){
				            			 requestTip.success("全场静麦成功！");
				            			 allShutStr="<i class='iconfont'>&#xe7f0;</i>";
                                         $(".allShutIcon").attr("att",'1');
				            			 $(".allShutIcon").html(allShutStr);
				            			 $(".allShutIcon").attr("title","全场开麦");
				            			 $(".shutdIcon").attr("mutePStatus","1");
				            			 $(".shutdIcon").html("<i class='iconfont' title='开麦'>&#xe7f0;</i>");
                                         ws.send(JSON.stringify({mute:confId+'0'}))
				            		 }
				            		 else{
				            			 requestTip.success("全场开麦成功！");
				            			 allShutStr="<i class='iconfont'>&#xe601;</i>";
                                         $(".allShutIcon").attr("att",'0');
				            			 $(".allShutIcon").html(allShutStr);
				            			 $(".allShutIcon").attr("title","全场静麦");
				            			 $(".shutdIcon").attr("mutePStatus","0");
				            			 $(".shutdIcon").html("<i class='iconfont' title='静麦'>&#xe601;</i>");
                                         ws.send(JSON.stringify({mute:confId+'1'}))
				            		 }
				            		 break;
			            		 default:
			            			 requestTip.error();
			            		     break;
			            	 }
			             },
			             beforeSend:function(){
			            	 requestTip.wait();
			             },
		            	 error:function(){
		            		 requestTip.error();
			             }
			         });
			 });

			 //全场静音
			 $(".allSilenIcon").unbind().on("click",function(){
				 var confId = $("#confId").val();
				 var status=$(".allSilenIcon").attr("att");
				 var allSilenStatus=$(".allSilenIcon").attr("title");
				 var allSilenStr="";
				 var params={
							"confId":confId,
							"params":{
								"value":status==0?1:0
								}
						 }
				    var requestTip=base.requestTip({position:"center"});
					$.ajax({
						type: "POST",
		                url:$.base + "/liveController/allSilence",
		                data:JSON.stringify(params),
		                contentType:"application/json",
		                success: function(data){

			            	 switch(data.status){
				            	 case '1':

				            		 if(status=="0"){
				            			 requestTip.success("全场静音成功！");
				            			 allSilenStr="<i class='iconfont'>&#xe64a;</i>";
                                         $(".allSilenIcon").attr("att",'1');
				            			 $(".allSilenIcon").html(allSilenStr);
				            			 $(".allSilenIcon").attr("title","全场停止静音");
				            			 $(".silenIcon").attr("silencePStatus","1");
				            			 $('.silenIcon').html("<i class='iconfont' title='停止静音'>&#xe64a;</i>");
				            			 ws.send(JSON.stringify({silence:confId+'0'}))
				            		 }
				            		 else{
				            			 requestTip.success("全场停止静音成功！");
				            			 allSilenStr="<i class='iconfont'>&#xe62d;</i>";
                                         $(".allSilenIcon").attr("att",'0');
				            			 $(".allSilenIcon").html(allSilenStr);
				            			 $(".allSilenIcon").attr("title","全场静音");
				            			 $(".silenIcon").attr("silencePStatus","0");
				                         $('.silenIcon').html("<i class='iconfont' title='静音'>&#xe62d;</i>");
				            			 ws.send(JSON.stringify({silence:confId+'1'}))
				            		 }
				            		 break;
			            		 default:
			            			 requestTip.error();
			            		     break;
			            	 }
			             },
			             beforeSend:function(){
			            	 requestTip.wait();
			             },
		            	 error:function(){
		            		 requestTip.error();
			             }
			      });
			 });

			 //点击添加字幕
			 $(".subtitleIcon").unbind().on("click",function(){
				 $(".subtitle").removeClass("disNone");
				 $(".subtitle").siblings().addClass("disNone");
				 $(".detailBannerLi").removeClass("backColor");
				 //提交
				 $(".subtitleSubmit").unbind().on("click",function(){
				 	if($("#subtitleContent").val().trim()==""){
				 		base.confirm({
	                        label:"提示",
	                        text:"<div style='text-align:center;font-size:13px;'>请输入字幕内容！</div>"
	                    });
					}else{
						var array=[];
					 	 if(isAdmin||participant.isHost==='1'){
					 	 	$.each(participants,function (i,v) {
								array.push({mt_id:v.mtId})
	                        })
						 }
						 else{
					 	 	array.push({mt_id:participant.mtId})
						 }
					 	var params = {
		                         confId: $('#confId').val(),
		                         params:{
		                             "message": $("#subtitleContent").val(),
		                             "type": $("#scrollType").find("option:selected").val()-0,
		                             "roll_num": 1,
		                             "roll_speed": 1,
		                             "mts": array
		                         }
		                     };
					 	var requestTip=base.requestTip({position:"center"});
						 $.ajax({
				               type: "post",
				               url:  $.base + "/liveController/sendScreenWord",
							   data:JSON.stringify(params),
							   dataType:'json',
		                       contentType:"application/json",
				               success: function(data){
					               switch(data.status){
						            	 case '1':
						            		 requestTip.success("添加字幕成功！");
						            		 break;
					            		 default:
					            			 requestTip.error(data.tips);
					            		     break;
					            	 }
					             },
					             beforeSend:function(){
					            	 requestTip.wait();
					             },
				            	 error:function(){
				            		 requestTip.error();
					             }
						 });
					}
				 });
				//取消
				 $(".subtitleCancel").off().on("click",function(){
					 $("#scrollType").val("");
		             $("#subtitleContent").val("");
				 });
			 });

			 function setDragNum(confId){
				$(".dragNumUl li").on("click",function(){
					$(this).siblings().removeClass("dragNumLi");
					$(this).addClass("dragNumLi");
					var dragNum=parseInt($(this).attr("att"));
					var dragBoxStr="";
					if(dragNum==2){
						getPicSyn(confId,dragNum);
						$(".dragBoxDiv").removeClass("dragTwoDiv dragThreeDiv dragFourDiv");
						$(".dragBoxDiv").addClass("dragTwoDiv");
					}else if(dragNum==3){
						getPicSyn(confId,dragNum);
						$(".dragBoxDiv").removeClass("dragTwoDiv dragThreeDiv dragFourDiv");
						$(".dragBoxDiv").addClass("dragThreeDiv");
					}else if(dragNum==4){
						getPicSyn(confId,dragNum);
						$(".dragBoxDiv").removeClass("dragTwoDiv dragThreeDiv dragFourDiv");
						$(".dragBoxDiv").addClass("dragFourDiv");
					}
				});
			 }

			 //获得先前合成的画面
			 function getPicSyn(confId,num){
				 var requestTip=base.requestTip({position:"center"});
                 $.ajax({
                     type: "post",
                     url:  $.base + "/liveController/getPictureSynthesiss",
                     data:JSON.stringify({confId:confId}),
                     contentType:"application/json",
                     success: function(data){
                         switch(data.status){
                             case '1':
                            	 if(data.data){
                            		 var synthPar=data.data;
                            		 var screenObj=participants;
                            		 var dragLength=synthPar.length;
                            		 if(dragLength>num){
                            			 base.confirm({
       							    	    label:"提示",
       							    	    text:"<div style='text-align:center;font-size:13px;'>已有合成参与方"+synthPar.length+"个，大于所选合成画面！</div>"
       								     });
                            			 $(".synthesisRegion .dragBoxDiv").html("");
                                		 for(var i=0;i<num;i++){
                                     		$(".synthesisRegion .dragBoxDiv").append("<div class='dragBox'></div>");
                                     	 }
                                		 dragObj.init($(".dragBox"));
                            		 }else if(synthPar.length<=num){
                            			 var selectedPar="";
                                         $(".synthesisRegion .dragBoxDiv").html("");
    	                                 $.each(synthPar,function(i,v){
    	                                	 $.each(screenObj,function(x,y){
    		                                   	 if(v.mtId==y.mtId){
    		                                   		selectedPar+="<div class='dragBox'><i class='fa fa-trash-o removedragPickTools' style='font-size:14px;cursor:pointer;float:right;margin:2px;' title='移除'></i>"+
    												"<div uid='"+y.mtId+"' style='float:left;width:100%;text-align:center;font-size:14px;padding-top:22px'>"+y.hospitalName+"</div></div>";
    		                                   	 }
    	                                	 });
    									 });
    	                                 $(".synthesisRegion .dragBoxDiv").append(selectedPar);

	                                     if(dragLength<num){
	                                    	 for(var i=0;i<(num-dragLength);i++){
	                                    		$(".synthesisRegion .dragBoxDiv").append("<div class='dragBox'></div>");
	                                    	 }
	                                     }
	                                     dragObj.init($(".dragBox"));
                            		 }
                            	 }
                            	 else{
                            		 $(".synthesisRegion .dragBoxDiv").html("");
                            		 for(var i=0;i<num;i++){
                                 		$(".synthesisRegion .dragBoxDiv").append("<div class='dragBox'></div>");
                                 	 }
                            		 dragObj.init($(".dragBox"));
                            	 }
                                 break;
                             default:
                                 requestTip.error(data.tips);
                                 break;
                         }
                     },
                     error:function(){
                         requestTip.error();
                     }
                 });
			 }

			//点击画面合成
			 $(".synthesisIcon").unbind().on("click",function(){
				 $(".synthesis").removeClass("disNone");
				 $(".synthesis").siblings().addClass("disNone");
                 var confId = $("#confId").val();
				 $(".detailBannerLi").removeClass("backColor");

                 setDragNum(confId);//画面合成数量

				 $(".synthesisSubmit").off().on("click",function(){
                     var mtIds=[];
                     var selectLength=$(".synthesis .dragBox i").length;
                     var requestTip=base.requestTip({position:"center"});
                     for(var i=0;i<selectLength;i++){
                         mtIds.push(
                             {
                                 "mt_id":$(".synthesis .dragBox:nth-child("+(i+1)+")  div").attr("uid"),
                                 "chn_idx": i,
                                 "member_type": 1
                             });
					 }
					 if(mtIds.length===0){
                         requestTip.error("请选择需要和成的画面");
					 }else{
                         var layout = selectLength === 1 ? 1 : selectLength === 2 ? 2 : selectLength === 3 ? 4 : selectLength === 4 ? 5 : void(0);
						 var params={
		                     	 confId:confId,
		                         params:{
		                             "mode":1,
		                             "voice_hint": 1,
		                             "broadcast": 1,
		                             "layout": layout,
		                             "show_mt_name": 1,
		                             "members": mtIds
		                         }
		                     }
						 $.ajax({
	                         type: "POST",
	                         url:$.base + "/liveController/pictureSynthesiss",
	                         data:JSON.stringify(params),
	                         contentType:"application/json",
	                         success: function(data){
	                             switch(data.status){
	                                 case '1':
	                                     requestTip.success("画面合成成功！");
	                                     $(".detailBannerLi").css("background","#00479d");
	                                     dragObj.init($(".dragBox"));
	                                     break;
	                                 case '-1':
	                                     requestTip.error("合成失败："+data.tips);
	                                     break;
	                             }
	                         },
	                         beforeSend:function(){
	                             requestTip.wait();
	                         },
	                         error:function(){
	                             requestTip.error();
	                         }
	                     });
					 }
				  });
				});
				 //取消画面合成
					$('.synthesisCancel').off().on("click",function(){
                        var confId = $("#confId").val();
                        var params={
                            confId:confId
                        }
                        var requestTip=base.requestTip({position:"center"});
                        $.ajax({
                            type: "POST",
                            url:$.base + "/liveController/cancelPictureSynthesiss",
                            data:JSON.stringify(params),
                            contentType:"application/json",
                            success: function(data){
                                switch(data.status){
                                    case '1':
                                        requestTip.success("取消画面合成成功！");
                                        $(".dragBoxDiv .dragBox").html("");
                                        $(".detailBannerLi").css("background","#00479d");
                                        dragObj.init($(".dragBox"));
                                        break;
                                    case '-1':
                                        requestTip.error("取消合成失败："+data.tips);
                                        break;
                                }
                            },
                            beforeSend:function(){
                                requestTip.wait();
                            },
                            error:function(){
                                requestTip.error();
                            }
                        });
					});
			 //点击画面选看
			 $(".screenIcon").unbind().on("click",function(){
				 $(".screen").removeClass("disNone");
				 $(".screen").siblings().addClass("disNone");
				 $(".detailBannerLi").removeClass("backColor");
				 var requestTip=base.requestTip({position:"center"});

				 var confId = $("#confId").val();

				 if($(".parListSele")){
                     getPartiList(confId);//select下拉框获得数据

	                 $(".partiList").change( function() {
	                	 getScreenData(confId);
	                 });

				 }else{
					 getScreenData(confId);
				 }


                 $(".screenSubmit").off().on("click",function(){
                     var srcMtId=$(".screen .dragBox div").attr("uid");
					 if(!srcMtId){
                         requestTip.error("请选择要选看的医院");
					 }else{
						 var mtValue=$(".partiList").find("option:selected").val();
						 if(!mtValue){
							 mtValue=thisMtId;
						 }

						 var params={
		                         confId:confId,
		                         params:{
		                             "mode": 1,
		                             "src": {
		                                 "type": 1,
		                                 "mt_id": srcMtId
		                             },
		                             "dst": {
		                                 "mt_id":mtValue
		                             }
		                         }
		                     }
						 var requestTip=base.requestTip({position:"center"});
						 $.ajax({
	                         type: "post",
	                         url:  $.base + "/liveController/choosePicture",
	                         data:JSON.stringify(params),
	                         contentType:"application/json",
	                         success: function(data){
	                             switch(data.status){
	                                 case '1':
	                                     requestTip.success("画面选看成功！");
	                                     $(".detailBannerLi").css("background","#00479d");
	                                     dragObj.init($(".dragBox"));
	                                     break;
	                                 default:
	                                     requestTip.error(data.tips);
	                                     break;
	                             }
	                         },
	                         beforeSend:function(){
	                             requestTip.wait();
	                         },
	                         error:function(){
	                             requestTip.error();
	                         }
	                     });
					 }
				 });
				 //取消画面选看
                 $(".screenCancel").off().on("click",function(){

                	 var currentMtId;
                	 if(adminName=="kscc管理员"){
                		 currentMtId=$(".partiList").val();
                	 }else{
                		 currentMtId=thisMtId;
                	 }
                     var params={
                         confId:confId,
						 mtId:currentMtId
                     }
                     var requestTip=base.requestTip({position:"center"});
                     $.ajax({
                         type: "post",
                         url:  $.base + "/liveController/cancelChoosePicture",
                         data:JSON.stringify(params),
                         contentType:"application/json",
                         success: function(data){
                             switch(data.status){
                                 case '1':
                                     requestTip.success("取消画面选看成功！");
                                     $(".dragBoxOne").html("");
                                     $(".detailBannerLi").css("background","#00479d");
                                     $(".screen .dragBox").html("");
                                     $(".parListSele .partiList").val("");
                                     dragObj.init($(".dragBox"));
                                     break;
                                 default:
                                     requestTip.error(data.tips);
                                     break;
                             }
                         },
                         beforeSend:function(){
                             requestTip.wait();
                         },
                         error:function(){
                             requestTip.error();
                         }
                     });
				 });
			 });

			//管理员点击直播延时
			 $(".delayIcon").unbind().on("click",function(){
				 var confId = $("#confId").val();
				 $(".delay").removeClass("disNone");
				 $(".delay").siblings().addClass("disNone");
				 $(".detailBannerLi").removeClass("backColor");
				 
			     setInterval(function(){
			    	 var returnObj=counter();
			    	 var countDownstr = returnObj.day + "天" + returnObj.hour + "时" + returnObj.minute + "分";
			    	 $("#remainingTime").text(countDownstr);
			     }, 1000); //设置当前直播剩余时间
			     
				 //提交
				 $(".delaySubmit").unbind().on("click",function(){
					 var delay_time=$("input[type='radio']:checked").val();

					 if(delay_time){
						 if(delay_time==0){
							 delay_time=$("#customMin").val();
                             var r = /^\+?[1-9][0-9]*$/;
                             var flag=r.test(delay_time);
                             if(flag){
							 }else{
								 base.confirm({
							    	  label:"提示",
							    	  text:"<div style='text-align:center;font-size:13px;'>请输入正确的分钟数！</div>"
								 });
								 return;
                             }
                         }
						
						 if(sysRole=="kscc管理员"){
							 var parmas={
									    "confId":confId,
										"delay_time":delay_time	 
									 };
							 var requestTip=base.requestTip({position:"center"});
							 $.ajax({ 
					               type: "post",
					               url:  $.base + "/liveController/extendTime",
								   data:JSON.stringify(parmas),
				                   contentType:"application/json",
					               success: function(data){
						               switch(data.status){
							            	 case '1':
								            	 requestTip.success("延时成功！");
								            	 var message="管理员延长直播"+delay_time+"分钟";
								                 message=JSON.stringify({extendAdmin:message});
								                 ws.send(message);
								            	 extendTime(delay_time);
							            		 break;
						            		 default:
						            			 requestTip.error("延时失败！");
						            		     break;
						            	 }
						             },
						             beforeSend:function(){
						            	 requestTip.wait();
						             },
					            	 error:function(){
					            		 requestTip.error();
						             }
							 });
						 }
					 }
				 });

				//取消
				 $(".delayCancel").unbind().on("click",function(){
					 $("input[type='radio']").attr("checked",false);
		             $("#customMin").val("");
				 });
			 });

			//关闭录像
			 $(".closeVideo").unbind().on("click",function(){
			   var requestTip=base.requestTip({position:"center"});
			   $.ajax({
	               type: "post",
	              // url:  $.base + "/liveController/extendTime",
				   data:JSON.stringify(parmas),
                   contentType:"application/json",
	               success: function(data){
		               switch(data.status){
			            	 case '1':
			            		 requestTip.success("关闭录像成功！");
			            		 break;
		            		 default:
		            			 requestTip.error("关闭录像失败！");
		            		     break;
		            	 }
		             },
		             beforeSend:function(){
		            	 requestTip.wait();
		             },
	            	 error:function(){
	            		 requestTip.error();
		             }
			    });
			 });

			//退出直播
			 $(".outLive").unbind().on("click",function(){
				 base.confirm({
			    	  label:"提示",
			    	  text:"<div style='text-align:center;font-size:13px;'>确定退出直播吗?</div>",
		              confirmCallback:function(){
			    	  	if(thisMtId){
			    	  		var confId=$('#confId').val()
                            var data={confId:confId,ishost:ishost,params:{mts:[{mt_id:thisMtId}]},liveId:$("#liveIdControlDetail").val()}
                            var requestTip=base.requestTip({position:"center"});
                            $.ajax({
                                type: "post",
                                url:  $.base + "/liveController/getOutMeeting",
                                data:JSON.stringify(data),
                                dataType:'json',
                                contentType:"application/json",
                                success: function(e1){
                                    if(e1.status==='1'){
                                    	if(e1.data){
                                    		ws.send(JSON.stringify({hostOut:confId}))
										}
                                        var url=$.base+"/loginController/toLiveControlList";
                                        $.ajax({
                                            type:"GET",
                                            url:url,
                                            error:function(){
                                                alert("加载错误！");
                                            },
                                            success:function(e2){
                                                if(e2.indexOf('06a5bb21-b8f0-4dfd-8004-4b4e17d4f81c')!==-1){
                                                    window.location.href=$.base+'/loginController/toLogin'
                                                    return
                                                }
                                                $(".middle").html(e2);
                                            }
                                        });
                                    }
                                    else{
                                        requestTip.error(e1.tips)
                                    }
                                },
                                error:function(){
                                    requestTip.error();
                                }
                            });
						}
						else{
                            var url=$.base+"/loginController/toLiveControlList";
                            $.ajax({
                                type:"GET",
                                url:url,
                                error:function(){
                                    alert("加载错误！");
                                },
                                success:function(e2){
                                    if(e2.indexOf('06a5bb21-b8f0-4dfd-8004-4b4e17d4f81c')!==-1){
                                        window.location.href=$.base+'/loginController/toLogin'
                                        return
                                    }
                                    $(".middle").html(e2);
                                }
                            });
						}
		              }
				 });
			 });

			//结束直播
			 $(".endLive").unbind().on("click",function(){
               var confId = $("#confId").val();
               base.confirm({
			    	  label:"提示",
			    	  text:"<div style='text-align:center;font-size:13px;'>确定结束直播吗?</div>",
		              confirmCallback:function(){
		            	  var requestTip=base.requestTip({position:"center"});
		            	  $.ajax({
				               type: "post",
				               url:  $.base + "/liveController/endLive",
							   data:JSON.stringify({confId:confId}),
							   dataType:'json',
			                   contentType:"application/json",
				               success: function(data){
						            	if(data.status=='1'){
						            		 requestTip.success("结束直播成功！");
						            		 ws.send(JSON.stringify({endLive:confId}))
						            		 var url=$.base+"/loginController/toLiveControlList";
												$.ajax({
									                type:"GET",
									                url:url,
									                error:function(){
									                   alert("加载错误！");
									                },
									                success:function(data){
                                                        if(data.indexOf('06a5bb21-b8f0-4dfd-8004-4b4e17d4f81c')!==-1){
                                                            window.location.href=$.base+'/loginController/toLogin'
                                                            return
                                                        }
                                                        $(".middle").html(data);
									                }
									             });
						            	}else{
						            		 requestTip.error("结束直播失败！");
						            	}
					            },
				               beforeSend:function(){
				            	 requestTip.wait();
				               },
			            	   error:function(){
			            		 requestTip.error();
				               }
						    });
		              }
				 });
			 });

			//点击会场记录
			 $(".recordIcon").unbind().on("click",function(){
				 $(".record").removeClass("disNone");
				 $(".record").siblings().addClass("disNone");
				 $(".detailBannerLi").removeClass("backColor");
				 $("#tblRecord").dataTable().fnDestroy();
				 setTableRecord();
			 });
			 //点击申请发言
			 $(".applySpeak").unbind().on("click",function () {
			 	var confId=$('#confId').val()
                 var _this = this;
                 hospitalsName = $("#userName").text() //获取当前医院
			 	 var message=confId+hospitalsName+"申请发言!";
				 message=JSON.stringify({apply:message});
				 ws.send(message);
             });
             //主持人点击申请直播延时
             $(".applyExtendTime").unbind().on("click",function () {
                 var confId=$('#confId').val();
                 var _this = this;
                 
                 $(".delay").removeClass("disNone");
				 $(".delay").siblings().addClass("disNone");
				 $(".detailBannerLi").removeClass("backColor");
				
				 //设置当前直播剩余时间    
				 setInterval(function(){
			    	 var returnObj=counter();
			    	 var countDownstr = returnObj.day + "天" + returnObj.hour + "时" + returnObj.minute + "分";
			    	 $("#remainingTime").text(countDownstr);
			     }, 1000); 
				 
			     //提交
				 $(".delaySubmit").unbind().on("click",function(){
					 var delay_time=$("input[type='radio']:checked").val();

					 if(delay_time){
					     //延时直播时间，产生消息信息
                         markMessages(delay_time);

						 if(delay_time==0){
							 delay_time=$("#customMin").val();
                             var r = /^\+?[1-9][0-9]*$/;
                             var flag=r.test(delay_time);
                             if(flag){
							 }else{
								 base.confirm({
							    	  label:"提示",
							    	  text:"<div style='text-align:center;font-size:13px;'>请输入正确的分钟数！</div>"
								 });
								 return;
                             }
                         }
						 hospitalsName = $("#userName").text() //获取当前医院
		                 var message=confId+hospitalsName+"申请延长直播"+delay_time+"分钟";
		                 message=JSON.stringify({apply:message});
		                 ws.send(message);
					 }
				 });
				 //取消
				 $(".delayCancel").unbind().on("click",function(){
					 $("input[type='radio']").attr("checked",false);
		             $("#customMin").val("");
				 });
             });
		 }

		 //更新直播间页面结束时间
         function extendTime(time){
             var delay_time=$("input[type='radio']:checked").val();
             if(delay_time==0){
                 delay_time=$("#customMin").val();
             }else{
            	 delay_time=time;
             }
             param={
                 "liveId":$("#liveIdControlDetail").val(),
                 "timeExpand":delay_time
             }
             $.ajax({
                 type: "post",
                 url:  $.base + "/liveBroadCastController/updateEndTime",
                 data:JSON.stringify(param),
                 contentType:"application/json",
                 success: function(data){
                     $("#liveEndTime").text(data);
                 }
             });
         }
        // 延时产生消息信息
         function markMessages(time) {
             var delay_time=$("input[type='radio']:checked").val();
             if(delay_time==0){
                 delay_time=$("#customMin").val();
             }else{
                 delay_time=time;
             }
             param={
                 "liveId":$("#liveIdControlDetail").val(),
                 "timeExpand":delay_time
             }
             $.ajax({
                 type: "post",
                 url:  $.base + "/messageContorller/markExtendMessages",
                 data:JSON.stringify(param),
                 contentType:"application/json",
                 success: function(data){
                     //$("#liveEndTime").text(data);
                 }
             });
         }

        //获取消息信息数量
        function getMessageLiveNum() {
            param={
                //"liveId":$("#liveIdControlDetail").val(),
                //"addressee":-1,
                "status":1 //未读信息
            }
            $.ajax({
                type: "post",
                url:  $.base + "/messageContorller/queryExtendCount",
                data:JSON.stringify(param),
                contentType:"application/json",
                success: function(data){
                    if(data!=0){
                        $(".msgNum").show();
                        $(".msgNum").text(data)
                    }else{
                        $(".msgNum").hide();
                    }
                }
            });
        }
       //加载select框数据
        function getPartiList(confId){
            var requestTip=base.requestTip({position:"center"});
            $.ajax({
                type: "GET",
                url:$.base + "/liveBroadCastController/getLiveDetailTwo/"+$("#liveIdControlDetail").val(),
                contentType:"application/json",
                success: function(data){
                    var partiOptions=data.participants;
                    $(".partiList").empty();
                    $.each(partiOptions,function(i,v){
                        $("<option value='"+v.mtId+"'>"+v.hospitalName+"</option>").appendTo(".partiList");
                    });
                    getScreenData(confId);
                },
                error:function(){}
            });
        }
        //加载之前选看的结果
        function getScreenData(confId){
            $.ajax({
                type: "post",
                url:  $.base + "/liveController/getChoosePicture",
                data:JSON.stringify({confId:confId}),
                contentType:"application/json",
                success: function(data){
                    switch(data.status){
                        case '1':

                         if(data.data){
                             var parVal=$(".partiList").val();
                             var selectedPar="";
                             if(parVal){
                                $.each(data.data,function(i,v){
                                    dragObj.init($(".dragBox"));//初始化拖拽对象
                                     if(parVal==v.dst){
                                        selectedPar="<i class='fa fa-trash-o removedragPickTools' style='font-size:14px;cursor:pointer;float:right;margin:2px;' title='移除'></i>"+
                                        "<div uid='"+v.src+"' style='float:left;width:100%;text-align:center;font-size:14px;padding-top:122px'>"+v.srcHospitalName+"</div>";
                                        $(".screen .dragBox").html("");
                                        $(".screen .dragBox").append(selectedPar);
                                     }
                                 });
                             }else{
                                    selectedPar="<i class='fa fa-trash-o removedragPickTools' style='font-size:14px;cursor:pointer;float:right;margin:2px;' title='移除'></i>"+
                                    "<div uid='"+data.data[0].src+"' style='float:left;width:100%;text-align:center;font-size:14px;padding-top:122px'>"+data.data[0].srcHospitalName+"</div>";
                                    $(".screen .dragBox").html("");
                                    $(".screen .dragBox").append(selectedPar);
                              }
                            dragObj.init($(".dragBox"));//初始化拖拽对象
                            }
                            break;
                        default:
                            requestTip.error(data.tips);
                            break;
                    }
                },
                error:function(){
                    requestTip.error();
                }
            });
        }
        var dragObj;
		function setDrag(){
			 dragObj=base.dragPickBox({
				    items:$(".dragDetail"),
				    boxes:$(".dragBox"),
				    clickEvent:function(obj){
			               $(".detailBannerLi").css("background","#00479d");
			               $(obj).parents(".detailBannerLi").css("background","rgb(2,250,78)");
			            }
				});
		 }
		 
		 //30、10分钟倒计时提示
		 
		 function setTimeTip(){
			 setInterval(function(){
				 var returnObj=counter();
				 var flag=false;
				 if((returnObj.day==0)&&(returnObj.hour==0)&&((returnObj.minute==30)||(returnObj.minute==10))){
					 if(flag==false){
						 base.confirm({ 
					    	  label:"提示",
					    	  text:"<div style='text-align:center;font-size:13px;'>直播还剩<span>"+returnObj.minute+"</span>分钟，如需延时请申请！</div>"
						 });
						 $(".modal").hide();
						 flag=true;
					 }else{
						 flag=false;
					 }
				 }
			}, 60000);
		}
		return {
			run:function(){
				setLiveRoom();
				userId();
				setTableRecord();//设置会场记录
				setChange();//设置点击切换
                /*一分钟刷新一下消息数量*/
                setInterval(getMessageLiveNum,6000);
                setTimeTip();
			}
		};
})